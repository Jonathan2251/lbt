
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Appendix B: Clang library and tools &#8212; Tutorial: Creating an LLVM Toolchain for the Cpu0 Architecture</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/haiku.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Appendix C: POCL" href="pocl.html" />
    <link rel="prev" title="Appendix A: RISCV" href="riscv.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Toolchain for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Appendix B: Clang library and tools</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="riscv.html">Appendix A: RISCV</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="pocl.html">Appendix C: POCL</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="appendix-b-clang-library-and-tools">
<span id="sec-clang-tools"></span><h1>Appendix B: Clang library and tools<a class="headerlink" href="#appendix-b-clang-library-and-tools" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#install-llvm-with-clang-tools" id="id11">Install llvm with clang tools</a></p></li>
<li><p><a class="reference internal" href="#using-clang-as-a-library" id="id12">Using Clang as a Library</a></p>
<ul>
<li><p><a class="reference internal" href="#clang-plugins" id="id13">Clang Plugins</a></p></li>
<li><p><a class="reference internal" href="#using-libtooling-and-libastmatchers" id="id14">Using LibTooling and LibASTMatchers</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#using-clang-as-tools" id="id15">Using Clang as Tools</a></p>
<ul>
<li><p><a class="reference internal" href="#clang-query" id="id16">clang-query</a></p></li>
</ul>
</li>
</ul>
</nav>
<p>This chapter shows that Using Clang as a Library and Tools <a class="reference internal" href="#clang-doc" id="id1"><span>[clang-doc]</span></a>.</p>
<section id="install-llvm-with-clang-tools">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Install llvm with clang tools</a><a class="headerlink" href="#install-llvm-with-clang-tools" title="Permalink to this heading">¶</a></h2>
<p class="rubric">exlbt/clang-tools/install-llvm.sh</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/usr/bin/env bash

#export LLVM_VER=14.x
#export LLVM_VER=15.x
export LLVM_VER=16.x

export LLVM_SRC_DIR=$HOME/llvm/$LLVM_VER

get_llvm() {
  if [ ! -d &quot;$LLVM_SRC_DIR&quot; ]; then
    echo &quot;LLVM_SRC_DIR: $LLVM_SRC_DIR not exist&quot;
    exit 1
  fi
  pushd $LLVM_SRC_DIR
  git clone https://github.com/llvm/llvm-project.git
  cd llvm-project
  git checkout -b $LLVM_VER origin/release/$LLVM_VER
  popd
}

release_build_llvm_toolchain() {
  pushd $LLVM_SRC_DIR/llvm-project
  if [ -d &quot;$LLVM_SRC_DIR/llvm-project/release-build&quot; ]; then
    echo &quot;$LLVM_SRC_DIR/build exist already. Please remove it before run this bash&quot;
    exit 1
  fi
  mkdir release-build
  cd release-build
  cmake -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_PROJECTS=&quot;clang;clang-tools-extra&quot; \
  -DLLVM_PARALLEL_COMPILE_JOBS=4 -DLLVM_PARALLEL_LINK_JOBS=1 -G &quot;Ninja&quot; ../llvm \
  -DCLANG_BUILD_EXAMPLES=ON
  ninja
  popd
}

debug_build_llvm_toolchain() {
  pushd $LLVM_SRC_DIR/llvm-project
  if [ -d &quot;$LLVM_SRC_DIR/llvm-project/build&quot; ]; then
    echo &quot;$LLVM_SRC_DIR/build exist already. Please remove it before run this bash&quot;
    exit 1
  fi
  mkdir build
  cd build
  cmake -DCMAKE_BUILD_TYPE=Debug -DLLVM_ENABLE_PROJECTS=&quot;clang;clang-tools-extra&quot; \
  -DLLVM_PARALLEL_COMPILE_JOBS=4 -DLLVM_PARALLEL_LINK_JOBS=1 -G &quot;Ninja&quot; ../llvm \
  -DCLANG_BUILD_EXAMPLES=ON
  ninja
  popd
}

get_llvm;
release_build_llvm_toolchain;
debug_build_llvm_toolchain;
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">pwd</span>
<span class="gp">$ </span><span class="nv">$HOME</span>/lbt/exlbt/clang-tools
<span class="gp">$ </span>bash<span class="w"> </span>install-llvm.sh
</pre></div>
</div>
</section>
<section id="using-clang-as-a-library">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Using Clang as a Library</a><a class="headerlink" href="#using-clang-as-a-library" title="Permalink to this heading">¶</a></h2>
<section id="clang-plugins">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Clang Plugins</a><a class="headerlink" href="#clang-plugins" title="Permalink to this heading">¶</a></h3>
<p>References clang/examples/PrintFunctionNames <a class="reference internal" href="#id10" id="id2"><span>[clang-plugins]</span></a> <a class="reference internal" href="#clang-ast-fa" id="id3"><span>[clang-ast-fa]</span></a>.</p>
<p class="rubric">exlbt/clang-tools/Rewriter/plugin/README.txt</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Clang example:
  - Converter from cpp to cpp.
  - Modified from clang/examples/PrintFunctionNames.
  - Work on llvm 088f33605d8a61ff519c580a71b1dd57d16a03f8 of 15.x,
    f28c006a5895fc0e329fe15fead81e37457cb1d1 of 14.x and
    e8a397203c67adbeae04763ce25c6a5ae76af52c of 12.x.

Install:
  ~/git/lbt/exlbt/clang-tools/Rewriter/plugin$ cp -rf Rewriter ~/llvm/15.x/llvm-project/clang/examples/.
  echo &#39;add_subdirectory(Rewriter)&#39; &gt;&gt; ~/llvm/15.x/llvm-project/clang/examples/CMakeLists.txt

Run command:
  Check Rewriter/README.txt
</pre></div>
</div>
<p class="rubric">exlbt/clang-tools/Rewriter/plugin/Rewriter/README.txt</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>This is a simple example demonstrating how to use clang&#39;s facility for
providing AST consumers using a plugin.

Once the plugin is built, you can run it using:
--
Linux:
  $ &lt;llvm-build-path&gt;/bin/clang++ -Xclang -load -Xclang &lt;llvm-build-path&gt;/lib/Rewriter.so -Xclang -add-plugin -Xclang ex1-act -Xclang -emit-llvm -S input.cpp -o -
  for example:
    ~/llvm/15.x/llvm-project/build/bin/clang++ -Xclang -load -Xclang ~/llvm/15.x/llvm-project/build/lib/Rewriter.so -Xclang -add-plugin -Xclang ex1-act -Xclang -ast-dump -fsyntax-only input.cpp -o -

MacOS:
  Use Rewriter.dylib instead of .so.
</pre></div>
</div>
<p>Rewriter/exe/Linux and Rewriter/exe/macOS applies on Linux and macOS as follows,</p>
<p class="rubric">exlbt/clang-tools/Rewriter/exe/Linux/README.txt</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Clang example:
  - Converter from cpp to cpp
  - Work on llvm 088f33605d8a61ff519c580a71b1dd57d16a03f8 of 15.x.

build:
  exe/Linux$ make clean; make
run:
  ./build/Rewriter ../input.cpp
check:
  cat output.cpp
gdb:
  exe/Linux$ gdb --args ./build/Rewriter ../input.cpp 
  (gdb) b MyASTConsumer.cpp:61
  (gdb) r
  61	    TheRewriter.ReplaceText(CallerSR, StringRef(sBuiltinFunc));
</pre></div>
</div>
<p class="rubric">exlbt/clang-tools/Rewriter/exe/macOS/README.txt</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Clang</span> <span class="n">example</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">Converter</span> <span class="kn">from</span> <span class="nn">cpp</span> <span class="n">to</span> <span class="n">cpp</span>
  <span class="o">-</span> <span class="n">Work</span> <span class="n">on</span> <span class="n">llvm</span> <span class="mi">088</span><span class="n">f33605d8a61ff519c580a71b1dd57d16a03f8</span> <span class="n">of</span> <span class="mf">15.</span><span class="n">x</span><span class="o">.</span>

<span class="n">install</span><span class="p">:</span>
  <span class="o">%</span> <span class="n">brew</span> <span class="n">install</span> <span class="n">llvm</span>
<span class="n">build</span><span class="p">:</span>
  <span class="n">exe</span><span class="o">/</span><span class="n">macOS</span><span class="o">%</span> <span class="n">make</span> <span class="n">clean</span><span class="p">;</span> <span class="n">make</span>
<span class="n">run</span><span class="p">:</span>
  <span class="o">./</span><span class="n">build</span><span class="o">/</span><span class="n">Rewriter</span> <span class="o">../</span><span class="nb">input</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">check</span><span class="p">:</span>
  <span class="n">cat</span> <span class="n">output</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">gdb</span><span class="p">:</span>
  <span class="n">exe</span><span class="o">/</span><span class="n">macOS</span><span class="o">%</span> <span class="n">gdb</span> <span class="o">--</span><span class="n">args</span> <span class="o">./</span><span class="n">build</span><span class="o">/</span><span class="n">Rewriter</span> <span class="o">../</span><span class="nb">input</span><span class="o">.</span><span class="n">cpp</span> 
  <span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">b</span> <span class="n">MyASTConsumer</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">61</span>
  <span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">r</span>
  <span class="mi">61</span>	    <span class="n">TheRewriter</span><span class="o">.</span><span class="n">ReplaceText</span><span class="p">(</span><span class="n">CallerSR</span><span class="p">,</span> <span class="n">StringRef</span><span class="p">(</span><span class="n">sBuiltinFunc</span><span class="p">));</span>
</pre></div>
</div>
</section>
<section id="using-libtooling-and-libastmatchers">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Using LibTooling and LibASTMatchers</a><a class="headerlink" href="#using-libtooling-and-libastmatchers" title="Permalink to this heading">¶</a></h3>
<p>References clang-tools-extra/loop-convert <a class="reference internal" href="#clang-lamt" id="id4"><span>[clang-lamt]</span></a> <a class="reference internal" href="#clang-lam" id="id5"><span>[clang-lam]</span></a>.</p>
<p class="rubric">exlbt/clang-tools/loop-convert2/README.txt</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Work on llvm 088f33605d8a61ff519c580a71b1dd57d16a03f8 of 15.x
and f28c006a5895fc0e329fe15fead81e37457cb1d1 of 14.x.

install:
  ~/git/lbt/exlbt/clang-tools$ cp -rf loop-convert2 ~/llvm/15.x/llvm-project/clang-tools-extra/.
  echo &#39;add_subdirectory(loop-convert2)&#39; &gt;&gt; ~/llvm/15.x/llvm-project/clang-tools-extra/CMakeLists.txt

build:
  ~/llvm/14.x/llvm-project/build$ ninja
run:
  ~/git/lbt/exlbt/clang-tools$ ~/llvm/15.x/llvm-project/build/bin/loop-convert2 loop-test.cpp --
  Potential array-based loop discovered.
  ForStmt begin at 8:3
  ForStmt end at 10:3
  ~/git/lbt/exlbt/clang-tools$ ~/llvm/15.x/llvm-project/build/bin/loop-convert2 -debug loop-test.cpp --
  Potential array-based loop discovered.
  ForStmt 0x1378c7018
  |-DeclStmt 0x1378c6dc0
  | `-VarDecl 0x1378c6d38  used i &#39;int&#39; cinit
  |   `-IntegerLiteral 0x1378c6da0 &#39;int&#39; 0
  |-&lt;&lt;&lt;NULL&gt;&gt;&gt;
  |-BinaryOperator 0x1378c6ed8 &#39;_Bool&#39; &#39;&lt;&#39;
  | |-ImplicitCastExpr 0x1378c6ec0 &#39;int&#39; &lt;LValueToRValue&gt;
  | | `-DeclRefExpr 0x1378c6dd8 &#39;int&#39; lvalue Var 0x1378c6d38 &#39;i&#39; &#39;int&#39;
  | `-CallExpr 0x1378c6ea0 &#39;int&#39;
  |   `-ImplicitCastExpr 0x1378c6e88 &#39;int (*)(void)&#39; &lt;FunctionToPointerDecay&gt;
  |     `-DeclRefExpr 0x1378c6e40 &#39;int (void)&#39; lvalue Function 0x1378c6a40 &#39;expr&#39; &#39;int (void)&#39;
  |-UnaryOperator 0x1378c6f18 &#39;int&#39; lvalue prefix &#39;++&#39;
  | `-DeclRefExpr 0x1378c6ef8 &#39;int&#39; lvalue Var 0x1378c6d38 &#39;i&#39; &#39;int&#39;
  `-CompoundStmt 0x1378c7000
    `-BinaryOperator 0x1378c6fe0 &#39;int&#39; lvalue &#39;=&#39;
      |-DeclRefExpr 0x1378c6f30 &#39;int&#39; lvalue Var 0x1378c6c80 &#39;res&#39; &#39;int&#39;
      `-BinaryOperator 0x1378c6fc0 &#39;int&#39; &#39;+&#39;
        |-ImplicitCastExpr 0x1378c6f90 &#39;int&#39; &lt;LValueToRValue&gt;
        | `-DeclRefExpr 0x1378c6f50 &#39;int&#39; lvalue Var 0x1378c6c80 &#39;res&#39; &#39;int&#39;
        `-ImplicitCastExpr 0x1378c6fa8 &#39;int&#39; &lt;LValueToRValue&gt;
          `-DeclRefExpr 0x1378c6f70 &#39;int&#39; lvalue Var 0x1378c6d38 &#39;i&#39; &#39;int&#39;
  ForStmt begin at 8:3
  ForStmt end at 10:3
</pre></div>
</div>
</section>
</section>
<section id="using-clang-as-tools">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">Using Clang as Tools</a><a class="headerlink" href="#using-clang-as-tools" title="Permalink to this heading">¶</a></h2>
<section id="clang-query">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">clang-query</a><a class="headerlink" href="#clang-query" title="Permalink to this heading">¶</a></h3>
<p>References <a class="footnote-reference brackets" href="#astmatchers" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#astmatchersref" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#narrowing-matchers" id="id8" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>. RVV
reference ~/riscv/riscv_newlib/lib/clang/13.0.1/include/riscv_vector.h.</p>
<p class="rubric">exlbt/clang-tools/vecotor-dsl.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> 
<span class="o">~/</span><span class="n">riscv</span><span class="o">/</span><span class="n">riscv_newlib</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">clang</span><span class="o">++</span> <span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">menable</span><span class="o">-</span><span class="n">experimental</span><span class="o">-</span><span class="n">extensions</span> \
<span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">rv64gcv0p10</span> <span class="o">-</span><span class="n">O0</span> <span class="o">-</span><span class="n">mllvm</span> <span class="o">--</span><span class="n">riscv</span><span class="o">-</span><span class="n">v</span><span class="o">-</span><span class="n">vector</span><span class="o">-</span><span class="n">bits</span><span class="o">-</span><span class="nb">min</span><span class="o">=</span><span class="mi">256</span> <span class="o">-</span><span class="n">DUSE_RVV</span> <span class="o">-</span><span class="n">v</span> 
<span class="o">~/</span><span class="n">riscv</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">qemu</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">qemu</span><span class="o">-</span><span class="n">riscv64</span> <span class="o">-</span><span class="n">cpu</span> <span class="n">rv64</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">true</span> <span class="n">a</span><span class="o">.</span><span class="n">out</span>
<span class="o">~/</span><span class="n">riscv</span><span class="o">/</span><span class="n">riscv_newlib</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">elf</span><span class="o">-</span><span class="n">objdump</span> <span class="o">-</span><span class="n">d</span> <span class="n">a</span><span class="o">.</span><span class="n">out</span><span class="o">|</span><span class="n">grep</span> <span class="n">vmul</span>

<span class="n">The</span> <span class="n">following</span> <span class="n">work</span> <span class="k">for</span> <span class="c1">#undef USE_RVV</span>
<span class="o">~/</span><span class="n">llvm</span><span class="o">/</span><span class="mf">15.</span><span class="n">x</span><span class="o">/</span><span class="n">llvm</span><span class="o">-</span><span class="n">project</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">clang</span><span class="o">++</span> <span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">emit</span><span class="o">-</span><span class="n">llvm</span> <span class="o">-</span><span class="n">S</span> <span class="o">-</span><span class="n">Xclang</span> <span class="o">-</span><span class="n">ast</span><span class="o">-</span><span class="n">dump</span>

<span class="o">~/</span><span class="n">llvm</span><span class="o">/</span><span class="mf">15.</span><span class="n">x</span><span class="o">/</span><span class="n">llvm</span><span class="o">-</span><span class="n">project</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">query</span> <span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span> <span class="o">--</span>
<span class="n">clang</span><span class="o">-</span><span class="n">query</span><span class="o">&gt;</span> <span class="nb">set</span> <span class="n">traversal</span> <span class="n">IgnoreUnlessSpelledInSource</span>
<span class="n">clang</span><span class="o">-</span><span class="n">query</span><span class="o">&gt;</span> <span class="n">m</span> <span class="n">cxxOperatorCallExpr</span><span class="p">(</span><span class="n">binaryOperation</span><span class="p">(</span><span class="n">hasOperatorName</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">),</span><span class="n">hasLHS</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="n">hasType</span><span class="p">(</span><span class="n">cxxRecordDecl</span><span class="p">(</span><span class="n">hasName</span><span class="p">(</span><span class="s2">&quot;UVec32&quot;</span><span class="p">))))</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;lhs&quot;</span><span class="p">)),</span><span class="n">hasRHS</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="n">cxxOperatorCallExpr</span><span class="p">(</span><span class="n">binaryOperation</span><span class="p">(</span><span class="n">hasOperatorName</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">),</span><span class="n">hasLHS</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="n">cxxOperatorCallExpr</span><span class="p">(</span><span class="n">binaryOperation</span><span class="p">(</span><span class="n">hasOperatorName</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">),</span><span class="n">hasLHS</span><span class="p">(</span><span class="n">expr</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;lhs2&quot;</span><span class="p">)),</span><span class="n">hasRHS</span><span class="p">(</span><span class="n">expr</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;rhs2&quot;</span><span class="p">)))))</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;lhs1&quot;</span><span class="p">)),</span><span class="n">hasRHS</span><span class="p">(</span><span class="n">expr</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;rhs1&quot;</span><span class="p">)))))</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;rhs&quot;</span><span class="p">))))</span>

<span class="n">Match</span> <span class="c1">#1:</span>

<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;lhs&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
  <span class="o">^</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;lhs1&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
      <span class="o">^~~~~~~</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;lhs2&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
      <span class="o">^~~~~</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;rhs&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
      <span class="o">^~~~~~~~~~~</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;rhs1&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
                <span class="o">^</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;rhs2&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
            <span class="o">^</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;root&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
  <span class="o">^~~~~~~~~~~~~~~</span>
<span class="mi">1</span> <span class="n">match</span><span class="o">.</span>


<span class="n">More</span><span class="p">:</span>
<span class="n">clang</span><span class="o">-</span><span class="n">query</span><span class="o">&gt;</span> <span class="n">m</span> <span class="n">cxxOperatorCallExpr</span><span class="p">(</span><span class="n">binaryOperation</span><span class="p">(</span><span class="n">hasOperatorName</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">),</span><span class="n">hasLHS</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="n">hasType</span><span class="p">(</span><span class="n">cxxRecordDecl</span><span class="p">(</span><span class="n">hasName</span><span class="p">(</span><span class="s2">&quot;UVec32&quot;</span><span class="p">))))</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;lhs&quot;</span><span class="p">)),</span><span class="n">hasRHS</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="n">cxxOperatorCallExpr</span><span class="p">(</span><span class="n">binaryOperation</span><span class="p">(</span><span class="n">hasOperatorName</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">),</span><span class="n">hasLHS</span><span class="p">(</span><span class="n">expr</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;lhs1&quot;</span><span class="p">)),</span><span class="n">hasRHS</span><span class="p">(</span><span class="n">expr</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;rhs1&quot;</span><span class="p">)))))</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;rhs&quot;</span><span class="p">))))</span>
<span class="o">...</span> 
<span class="n">Match</span> <span class="c1">#2:</span>

<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;lhs&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
  <span class="o">^</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;lhs1&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
      <span class="o">^~~~~~~</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;rhs&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
      <span class="o">^~~~~~~~~~~</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;rhs1&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
                <span class="o">^</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;root&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
  <span class="o">^~~~~~~~~~~~~~~</span>

<span class="n">clang</span><span class="o">-</span><span class="n">query</span><span class="o">&gt;</span> <span class="n">m</span> <span class="n">cxxOperatorCallExpr</span><span class="p">(</span><span class="n">binaryOperation</span><span class="p">(</span><span class="n">hasOperatorName</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">),</span><span class="n">hasLHS</span><span class="p">(</span><span class="n">expr</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;lhs2&quot;</span><span class="p">)),</span><span class="n">hasRHS</span><span class="p">(</span><span class="n">expr</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;rhs2&quot;</span><span class="p">))))</span>
<span class="o">...</span>
<span class="n">Match</span> <span class="c1">#4:</span>

<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">cschen</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">lbt</span><span class="o">/</span><span class="n">exlbt</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">vector</span><span class="o">-</span><span class="n">dsl</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">154</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span> <span class="n">note</span><span class="p">:</span> <span class="s2">&quot;lhs2&quot;</span> <span class="n">binds</span> <span class="n">here</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
      <span class="o">^~~~~</span>
<span class="o">...</span>

<span class="n">Ref</span><span class="o">.</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">clang</span><span class="o">.</span><span class="n">llvm</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">LibASTMatchersReference</span><span class="o">.</span><span class="n">html</span><span class="c1">#narrowing-matchers</span>
<span class="o">*/</span>

<span class="c1">#include &quot;vector-dsl.h&quot;</span>
<span class="c1">#include &lt;assert.h&gt;</span>
<span class="c1">#include &lt;stddef.h&gt;</span>
<span class="c1">#include &lt;stdio.h&gt;</span>

<span class="c1">#ifdef USE_RVV</span>
<span class="c1">#include &lt;riscv_vector.h&gt;</span>
<span class="c1">#endif</span>

<span class="c1">#define array_size(a) (sizeof(a) / sizeof((a)[0]))</span>

<span class="n">const</span> <span class="n">Precision</span> <span class="n">bit16</span> <span class="o">=</span> <span class="n">Bit16</span><span class="p">;</span>

<span class="n">uint32_t</span> <span class="n">t</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">UVec32</span><span class="p">::</span><span class="n">UVec32</span><span class="p">(</span><span class="n">uint32_t</span> <span class="o">*</span><span class="n">A</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">aSize</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">aSize</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">UVec32</span><span class="o">&amp;</span> <span class="n">UVec32</span><span class="p">::</span><span class="n">Mul</span><span class="p">(</span><span class="n">const</span> <span class="n">uint32_t</span> <span class="n">Scalar</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">static</span> <span class="n">UVec32</span> <span class="n">res</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
  <span class="n">uint32_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">data</span><span class="p">;</span>
  <span class="n">uint32_t</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="c1">#ifdef USE_RVV</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">size_t</span> <span class="n">vl</span> <span class="o">=</span> <span class="n">vsetvl_e32m8</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="n">vuint32m8_t</span> <span class="n">vb</span> <span class="o">=</span> <span class="n">vle32_v_u32m8</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">vuint32m8_t</span> <span class="n">va</span> <span class="o">=</span> <span class="n">vmul</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="n">Scalar</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">vse32</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">a</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">n</span> <span class="o">-=</span> <span class="n">vl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="c1">#else</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Scalar</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
<span class="c1">#endif</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">UVec32</span><span class="o">&amp;</span> <span class="n">UVec32</span><span class="p">::</span><span class="n">Mul</span><span class="p">(</span><span class="n">const</span> <span class="n">UVec32</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">static</span> <span class="n">UVec32</span> <span class="n">res</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
  <span class="n">uint32_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">data</span><span class="p">;</span>
  <span class="n">uint32_t</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
  <span class="n">uint32_t</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">data</span><span class="p">;</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">arg</span><span class="o">.</span><span class="n">size</span><span class="p">);</span>
<span class="c1">#ifdef USE_RVV</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">size_t</span> <span class="n">vl</span> <span class="o">=</span> <span class="n">vsetvl_e32m8</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="n">vuint32m8_t</span> <span class="n">vb</span> <span class="o">=</span> <span class="n">vle32_v_u32m8</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">vuint32m8_t</span> <span class="n">vc</span> <span class="o">=</span> <span class="n">vle32_v_u32m8</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">vuint32m8_t</span> <span class="n">va</span> <span class="o">=</span> <span class="n">vmul</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">vse32</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">a</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">n</span> <span class="o">-=</span> <span class="n">vl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="c1">#else</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
<span class="c1">#endif</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">UVec32</span><span class="o">&amp;</span> <span class="n">UVec32</span><span class="p">::</span><span class="n">operator</span><span class="o">*</span><span class="p">(</span><span class="n">const</span> <span class="n">uint32_t</span> <span class="n">Scalar</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Mul</span><span class="p">(</span><span class="n">Scalar</span><span class="p">);</span>
<span class="p">}</span> 

<span class="n">UVec32</span><span class="o">&amp;</span> <span class="n">UVec32</span><span class="p">::</span><span class="n">operator</span><span class="o">*</span><span class="p">(</span><span class="n">const</span> <span class="n">UVec32</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Mul</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span> 

<span class="n">UVec32</span><span class="o">&amp;</span> <span class="n">UVec32</span><span class="p">::</span><span class="n">operator</span><span class="o">+</span><span class="p">(</span><span class="n">const</span> <span class="n">UVec32</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">static</span> <span class="n">UVec32</span> <span class="n">res</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
  <span class="n">uint32_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">data</span><span class="p">;</span>
  <span class="n">uint32_t</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
  <span class="n">uint32_t</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">data</span><span class="p">;</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">arg</span><span class="o">.</span><span class="n">size</span><span class="p">);</span>
<span class="c1">#ifdef USE_RVV</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">size_t</span> <span class="n">vl</span> <span class="o">=</span> <span class="n">vsetvl_e32m8</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="n">vuint32m8_t</span> <span class="n">vb</span> <span class="o">=</span> <span class="n">vle32_v_u32m8</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">vuint32m8_t</span> <span class="n">vc</span> <span class="o">=</span> <span class="n">vle32_v_u32m8</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">vuint32m8_t</span> <span class="n">va</span> <span class="o">=</span> <span class="n">vadd</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">vse32</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">a</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">n</span> <span class="o">-=</span> <span class="n">vl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="c1">#else</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
<span class="c1">#endif</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">UVec32</span><span class="p">::</span><span class="n">Print</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%u</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">UVec32</span><span class="o">&amp;</span> <span class="n">operator</span><span class="o">*</span><span class="p">(</span><span class="n">const</span> <span class="n">uint32_t</span> <span class="n">Scalar</span><span class="p">,</span> <span class="n">UVec32</span> <span class="o">&amp;</span><span class="n">B</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Scalar</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">uint32_t</span> <span class="n">gV1</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">uint32_t</span> <span class="n">gV2</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">uint32_t</span> <span class="n">gV3</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
<span class="p">};</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">UVec32</span> <span class="n">A</span><span class="p">(</span><span class="n">gV1</span><span class="p">,</span><span class="n">array_size</span><span class="p">(</span><span class="n">gV1</span><span class="p">)),</span> <span class="n">B</span><span class="p">(</span><span class="n">gV2</span><span class="p">,</span><span class="n">array_size</span><span class="p">(</span><span class="n">gV2</span><span class="p">)),</span> <span class="n">C</span><span class="p">(</span><span class="n">gV3</span><span class="p">,</span><span class="n">array_size</span><span class="p">(</span><span class="n">gV3</span><span class="p">));</span>
  <span class="n">uint32_t</span> <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span><span class="mi">2</span><span class="p">;</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">B</span> <span class="o">*</span> <span class="n">C</span><span class="p">;</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span><span class="p">;</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
  <span class="n">uint32_t</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">uint32_t</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">uint32_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;B: &quot;</span><span class="p">);</span> <span class="n">B</span><span class="o">.</span><span class="n">Print</span><span class="p">();</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;C: &quot;</span><span class="p">);</span> <span class="n">C</span><span class="o">.</span><span class="n">Print</span><span class="p">();</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;A: &quot;</span><span class="p">);</span> <span class="n">A</span><span class="o">.</span><span class="n">Print</span><span class="p">();</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">);</span>

  <span class="o">//</span> <span class="n">multiply</span> <span class="ow">and</span> <span class="n">add</span><span class="p">,</span> <span class="n">madd</span>
  <span class="o">//</span> <span class="n">A</span> <span class="o">=</span> <span class="n">B</span> <span class="o">*</span> <span class="n">C</span> <span class="o">+</span> <span class="n">D</span><span class="p">;</span> 
  <span class="o">//</span> <span class="n">Solve</span> <span class="n">above</span> <span class="n">by</span> <span class="k">class</span> <span class="nc">is</span> <span class="ow">not</span> <span class="n">efficient</span><span class="p">,</span> <span class="k">class</span> <span class="nc">does</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">madd</span><span class="o">.</span>
  <span class="o">//</span> <span class="n">DSL</span><span class="p">:</span> <span class="n">extend</span> <span class="n">clang</span> <span class="n">to</span> <span class="n">parsing</span> <span class="n">the</span> <span class="n">left</span> <span class="ow">and</span> <span class="n">calling</span> <span class="n">A</span> <span class="o">=</span> <span class="n">madd</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">D</span><span class="p">);</span> <span class="n">can</span> <span class="n">get</span> <span class="n">better</span> <span class="n">performance</span><span class="o">.</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>References <a class="footnote-reference brackets" href="#check-command" id="id9" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a> .</p></li>
</ul>
<div role="list" class="citation-list">
<div class="citation" id="clang-doc" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">clang-doc</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://clang.llvm.org/docs/index.html">https://clang.llvm.org/docs/index.html</a></p>
</div>
<div class="citation" id="id10" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">clang-plugins</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://clang.llvm.org/docs/ClangPlugins.html">https://clang.llvm.org/docs/ClangPlugins.html</a></p>
</div>
<div class="citation" id="clang-ast-fa" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">clang-ast-fa</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://clang.llvm.org/docs/RAVFrontendAction.html">https://clang.llvm.org/docs/RAVFrontendAction.html</a></p>
</div>
<div class="citation" id="clang-lamt" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">clang-lamt</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://clang.llvm.org/docs/LibASTMatchersTutorial.html">https://clang.llvm.org/docs/LibASTMatchersTutorial.html</a></p>
</div>
<div class="citation" id="clang-lam" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">clang-lam</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://clang.llvm.org/docs/LibASTMatchers.html">https://clang.llvm.org/docs/LibASTMatchers.html</a></p>
</div>
</div>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="astmatchers" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://clang.llvm.org/docs/LibASTMatchersTutorial.html">https://clang.llvm.org/docs/LibASTMatchersTutorial.html</a></p>
</aside>
<aside class="footnote brackets" id="astmatchersref" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://clang.llvm.org/docs/LibASTMatchersReference.html">https://clang.llvm.org/docs/LibASTMatchersReference.html</a></p>
</aside>
<aside class="footnote brackets" id="narrowing-matchers" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id8">3</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://clang.llvm.org/docs/LibASTMatchersReference.html#narrowing-matchers">https://clang.llvm.org/docs/LibASTMatchersReference.html#narrowing-matchers</a></p>
</aside>
<aside class="footnote brackets" id="check-command" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id9">4</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.youtube.com/watch?v=-iOtb6luK1Q">https://www.youtube.com/watch?v=-iOtb6luK1Q</a></p>
</aside>
</aside>
</section>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="riscv.html">Appendix A: RISCV</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="pocl.html">Appendix C: POCL</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Chen Chung-Shu.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.1.3.
    </div>
  </body>
</html>