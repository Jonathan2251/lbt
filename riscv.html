
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Appendix A: RISCV &#8212; Tutorial: Creating an LLVM Toolchain for the Cpu0 Architecture</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/haiku.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Appendix B: Clang library and tools" href="clang-tools.html" />
    <link rel="prev" title="LLDB" href="lldb.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Toolchain for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Appendix A: RISCV</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="lldb.html">LLDB</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="clang-tools.html">Appendix B: Clang library and tools</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="appendix-a-riscv">
<span id="sec-riscv"></span><h1>Appendix A: RISCV<a class="headerlink" href="#appendix-a-riscv" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#isa" id="id42">ISA</a></p></li>
<li><p><a class="reference internal" href="#mem" id="id43">Mem</a></p></li>
<li><p><a class="reference internal" href="#risc-compiler-toolchain-installation" id="id44">RISC compiler toolchain installation</a></p></li>
<li><p><a class="reference internal" href="#linker-command" id="id45">Linker Command</a></p></li>
<li><p><a class="reference internal" href="#qemu-simulator" id="id46">QEMU simulator</a></p></li>
<li><p><a class="reference internal" href="#gem5-simulator" id="id47">Gem5 Simulator</a></p></li>
<li><p><a class="reference internal" href="#gdb" id="id48">GDB</a></p></li>
<li><p><a class="reference internal" href="#riscv-calling-convention" id="id49">RISCV Calling Convention </a></p></li>
<li><p><a class="reference internal" href="#rvv" id="id50">RVV</a></p></li>
<li><p><a class="reference internal" href="#atomic-instructions" id="id51">Atomic instructions</a></p></li>
<li><p><a class="reference internal" href="#riscv-npu-for-deep-learning" id="id52">RISCV+NPU for Deep Learning</a></p></li>
<li><p><a class="reference internal" href="#resources" id="id53">Resources</a></p>
<ul>
<li><p><a class="reference internal" href="#freebsd" id="id54">FreeBSD</a></p></li>
<li><p><a class="reference internal" href="#freertos" id="id55">FreeRTOS</a></p></li>
<li><p><a class="reference internal" href="#zephyr" id="id56">Zephyr</a></p></li>
<li><p><a class="reference internal" href="#andes" id="id57">Andes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#websites" id="id58">Websites</a></p></li>
<li><p><a class="reference internal" href="#to-do" id="id59">To do:</a></p></li>
</ul>
</nav>
<p>This chapter shows the installation of the RISC toolchain, including GNU, LLVM,
and simulators on Linux, as illustrated in the figure and table below.</p>
<figure class="align-default" id="id35">
<span id="toolchain-f1"></span><div class="graphviz"><img src="_images/graphviz-8e35cf64bdab0b7fad41e40f16ac819c650f14d8.png" alt="digraph G {

  rankdir=LR;
  subgraph cluster_0 {
    style=filled;
    color=lightgrey;
//    label = &quot;RISCV toolchain flow&quot;;
    node [style=filled,color=white]; usercode [label = &quot;user program&quot;];
    node [style=filled,color=white]; sflib [label = &quot;lib (libm/libc/libstdc++)&quot;];
    node [style=filled,color=white]; linker [label = &quot;lld or ld&quot;];
    node [style=filled,color=white]; simulator [label = &quot;qemu or gem5&quot;];
    node [style=filled,color=white]; clang, llvm, gdb;
    usercode -&gt; clang;
    sflib -&gt; clang;
    clang -&gt; llvm [ label = &quot;IR&quot; ];
    llvm -&gt; linker [ label = &quot;obj&quot; ];
    linker -&gt; simulator [ label = &quot;exe&quot; ];
    linker -&gt; gdb [ label = &quot;exe&quot; ];
    simulator -&gt; gdb;
    gdb -&gt; simulator;
  }

}" class="graphviz" /></div>
<figcaption>
<p><span class="caption-number">Fig. 12 </span><span class="caption-text">RISCV toolchain flow</span><a class="headerlink" href="#id35" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<table class="docutils align-default" id="id36">
<caption><span class="caption-number">Table 6 </span><span class="caption-text">RISCV toolchain <a class="footnote-reference brackets" href="#toolchain" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></span><a class="headerlink" href="#id36" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Component</p></th>
<th class="head"><p>name</p></th>
<th class="head"><p>github</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>C/C++ Compiler</p></td>
<td><p>clang/llvm</p></td>
<td><p>llvm-project</p></td>
</tr>
<tr class="row-odd"><td><p>LLVM Assembler</p></td>
<td><p>llvm integrated assembler</p></td>
<td><p>“</p></td>
</tr>
<tr class="row-even"><td><p>LLVM Linker</p></td>
<td><p>ld.lld</p></td>
<td><p>“</p></td>
</tr>
<tr class="row-odd"><td><p>debug tool</p></td>
<td><p>lldb</p></td>
<td><p>“</p></td>
</tr>
<tr class="row-even"><td><p>Utils</p></td>
<td><p>llvm-ar, llvm-objdump etc.</p></td>
<td><p>“</p></td>
</tr>
<tr class="row-odd"><td><p>gcc Assembler</p></td>
<td><p>as</p></td>
<td><p>riscv-gnu-toolchain</p></td>
</tr>
<tr class="row-even"><td><p>gcc Linker</p></td>
<td><p>ld.bfd ld.gold</p></td>
<td><p>“</p></td>
</tr>
<tr class="row-odd"><td><p>Runtime</p></td>
<td><p>libgcc</p></td>
<td><p>“</p></td>
</tr>
<tr class="row-even"><td><p>Unwinder</p></td>
<td><p>libgcc_s</p></td>
<td><p>“</p></td>
</tr>
<tr class="row-odd"><td><p>C library</p></td>
<td><p>libc</p></td>
<td><p>“</p></td>
</tr>
<tr class="row-even"><td><p>C++ library</p></td>
<td><p>libsupc++ libstdc++</p></td>
<td><p>“</p></td>
</tr>
<tr class="row-odd"><td><p>debug tool</p></td>
<td><p>gdb</p></td>
<td><p>“</p></td>
</tr>
<tr class="row-even"><td><p>Utils</p></td>
<td><p>ar, objdump etc.</p></td>
<td><p>“</p></td>
</tr>
<tr class="row-odd"><td><p>Functional sim</p></td>
<td><p>qemu</p></td>
<td><p>qemu</p></td>
</tr>
<tr class="row-even"><td><p>Cycle sim</p></td>
<td><p>gem5</p></td>
<td><p>gem5</p></td>
</tr>
</tbody>
</table>
<section id="isa">
<h2><a class="toc-backref" href="#id42" role="doc-backlink">ISA</a><a class="headerlink" href="#isa" title="Permalink to this heading">¶</a></h2>
<figure class="align-center" id="id37">
<span id="riscv-f1"></span><a class="reference internal image-reference" href="_images/riscv-isa.png"><img alt="_images/riscv-isa.png" src="_images/riscv-isa.png" style="width: 272.0px; height: 360.0px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 13 </span><span class="caption-text">RISCV ISA</span><a class="headerlink" href="#id37" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-center" id="id38">
<span id="riscv-f2"></span><a class="reference internal image-reference" href="_images/isa-desc.png"><img alt="_images/isa-desc.png" src="_images/isa-desc.png" style="width: 673.0px; height: 575.0px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 14 </span><span class="caption-text">RISCV ISA Description</span><a class="headerlink" href="#id38" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>As shown in <a class="reference internal" href="#riscv-f1"><span class="std std-numref">Fig. 13</span></a> and <a class="reference internal" href="#riscv-f2"><span class="std std-numref">Fig. 14</span></a>, RISC has 32/64/128 bit
variants. The I (integer) extension is the base part, and others are optional.
G = IMAFD, the general extensions (i.e., I, M, A, F, D) <a class="footnote-reference brackets" href="#id33" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#riscv-wiki" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>
<a class="footnote-reference brackets" href="#rre" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>.</p>
<p>Since RISC-V has vector instructions supporting variable-length data and allows
vendors to encode variable-length instruction sets, little endian is the
dominant format in the market <a class="footnote-reference brackets" href="#endians-format" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a>.</p>
</section>
<section id="mem">
<h2><a class="toc-backref" href="#id43" role="doc-backlink">Mem</a><a class="headerlink" href="#mem" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>I-cache, D-cache: Size ranges from 4KB to 64KB in Andes N25f.</p></li>
<li><p>ILM, DLM: Size ranges from 4KB to 16MB <a class="footnote-reference brackets" href="#andes-ilm" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a>.</p>
<ul>
<li><p>For deterministic and efficient program execution</p></li>
<li><p>Flexible size selection to fit diversified needs</p></li>
</ul>
</li>
<li><p>DRAM</p></li>
</ul>
</section>
<section id="risc-compiler-toolchain-installation">
<h2><a class="toc-backref" href="#id44" role="doc-backlink">RISC compiler toolchain installation</a><a class="headerlink" href="#risc-compiler-toolchain-installation" title="Permalink to this heading">¶</a></h2>
<p>First, install the dependent packages following
<a class="reference external" href="https://github.com/riscv-collab/riscv-gnu-toolchain#readme">https://github.com/riscv-collab/riscv-gnu-toolchain#readme</a>. Next, create your
$HOME/riscv and $HOME/riscv/git directories. Then run the following bash script.</p>
<p class="rubric">exlbt/riscv/riscv-toolchain-setup.sh</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/usr/bin/env bash

# Verified on ubuntu 18.04
# mkdir riscv/git, riscv/riscv_newlib, riscv_linux before running this bash script
export LLVM_VER=14.x
#export LLVM_VER=13.0.0
export GNU_SRC_DIR=$HOME/riscv/git
export LLVM_SRC_DIR=$HOME/riscv/git/$LLVM_VER

export GNU_NEWLIB_INSTALL_DIR=$HOME/riscv/$LLVM_VER/riscv_newlib
export LLVM_NEWLIB_BUILD_DIR=$LLVM_SRC_DIR/llvm-project/build_riscv_newlib

export GNU_LINUX_INSTALL_DIR=$HOME/riscv/$LLVM_VER/riscv_linux
export LLVM_LINUX_BUILD_DIR=$LLVM_SRC_DIR/llvm-project/build_riscv_linux

riscv_gnu_toolchain_prerequisites() {
  sudo apt-get install autoconf automake autotools-dev curl python3 libmpc-dev \
  libmpfr-dev libgmp-dev gawk build-essential bison flex texinfo gperf libtool \
  patchutils bc zlib1g-dev libexpat-dev
  if [ ! -f &quot;/usr/bin/python&quot; ]; then
    sudo ln -s /usr/bin/python3 /usr/bin/python
  fi
}

riscv_llvm_prerequisites() {
  sudo apt-get install ninja-build
}

get_llvm() {
  if [ ! -d &quot;$GNU_SRC_DIR&quot; ]; then
    echo &quot;GNU_SRC_DIR: $GNU_SRC_DIR not exist&quot;
    exit 1
  fi
  rm -rf $LLVM_SRC_DIR
  mkdir $LLVM_SRC_DIR
  pushd $LLVM_SRC_DIR
  git clone https://github.com/llvm/llvm-project.git
  cd llvm-project
  git checkout -b $LLVM_VER origin/release/$LLVM_VER
  popd
}

check() {
  if [ ! -d &quot;$GNU_SRC_DIR&quot; ]; then
    echo &quot;GNU_SRC_DIR: $GNU_SRC_DIR not exist&quot;
    exit 1
  fi
  if [ -d &quot;$GNU_NEWLIB_INSTALL_DIR&quot; ]; then
    echo &quot;GNU_NEWLIB_INSTALL_DIR: $GNU_NEWLIB_INSTALL_DIR exist. Remove it before running.&quot;
    exit 1
  fi
  if [ -d &quot;$GNU_LINUX_INSTALL_DIR&quot; ]; then
    echo &quot;GNU_LINUX_INSTALL_DIR: $GNU_LINUX_INSTALL_DIR exist. Remove it before running.&quot;
    exit 1
  fi
}

build_gnu_toolchain() {
  pushd $GNU_SRC_DIR
  git clone https://github.com/riscv/riscv-gnu-toolchain
  cd riscv-gnu-toolchain
#  Looks branch change from original/rvv-intrinsic to origin/__archive__
#  git checkout -b rvv-intrinsic origin/rvv-intrinsic
# commit 409b951ba6621f2f115aebddfb15ce2dd78ec24f of master branch is work for vadd.vv of vadd1.c
  mkdir build_newlib
  cd build_newlib
# NX27V is 32-64 bits configurable and has HW float point
  ../configure --prefix=$GNU_NEWLIB_INSTALL_DIR \
  --with-arch=rv64gc --with-abi=lp64d
#  --with-multilib-generator=&quot;rv32i-ilp32--;rv32imafd-ilp32--;rv64ima-lp64--&quot;
  make -j4

  cd ..
  mkdir build_linux
  cd build_linux
  ../configure --prefix=$GNU_LINUX_INSTALL_DIR
  make linux -j4
  popd
}

# LLVM_OPTIMIZED_TABLEGEN: Builds a release tablegen that gets used during the LLVM build. This can dramatically speed up debug builds.
# LLVM_INSTALL_TOOLCHAIN_ONLY default is OFF already. Check CmakeCache.txt.
#   https://llvm.org/docs/BuildingADistribution.html?highlight=llvm_install_toolchain_only#difference-between-install-and-install-distribution
# LLVM_BINUTILS_INCDIR:
#   https://stackoverflow.com/questions/45715423/how-to-enable-cfi-in-llvm
#   For lld. https://llvm.org/docs/GoldPlugin.html
#   For llvm version 13.0.0 -DLLVM_BINUTILS_INCDIR will fail on ninja as follows,
#   /home/jonathanchen/riscv/git/13.0.0/llvm-project/llvm/tools/gold/gold-plugin.cpp:38:10: fatal error: plugin-api.h: No such file or directory
#    #include &lt;plugin-api.h&gt;
#             ^~~~~~~~~~~~~~
# -DLLVM_BINUTILS_INCDIR=$GNU_SRC_DIR/riscv-gnu-toolchain/riscv-binutils/include will incurs above fail on 13.x
# DEFAULT_SYSROOT: 
#   https://stackoverflow.com/questions/66357013/compile-clang-with-alternative-sysroot
# LLVM_DEFAULT_TARGET_TRIPLE:  
#   https://clang.llvm.org/docs/CrossCompilation.html#general-cross-compilation-options-in-clang
# LLVM_INSTALL_UTILS:BOOL
#   If enabled, utility binaries like FileCheck and not will be installed to CMAKE_INSTALL_PREFIX.
#   https://llvm.org/docs/CMake.html
# Use &quot;clang --sysroot&quot; if did not &quot;cmake -DDEFAULT_SYSROOT&quot;
# $LLVM_NEWLIB_BUILD_DIR/bin/clang++ --gcc-toolchain=$GNU_NEWLIB_INSTALL_DIR test.cpp -march=rv64g -O0 -mabi=lp64d -v
# $LLVM_LINUX_BUILD_DIR/bin/clang++ --gcc-toolchain=$GNU_LINUX_INSTALL_DIR --sysroot=$GNU_LINUX_INSTALL_DIR/sysroot/ --static test.cpp -march=rv64g -O0 -mabi=lp64d -v
build_llvm_toolchain() {
  rm -rf $LLVM_NEWLIB_BUILD_DIR
  mkdir $LLVM_NEWLIB_BUILD_DIR
  pushd $LLVM_NEWLIB_BUILD_DIR
  cmake -G &quot;Ninja&quot; -DCMAKE_BUILD_TYPE=Debug -DLLVM_TARGETS_TO_BUILD=&quot;RISCV&quot; \
  -DLLVM_ENABLE_PROJECTS=&quot;clang;lld&quot;  \
  -DLLVM_OPTIMIZED_TABLEGEN=On \
  -DCMAKE_INSTALL_PREFIX=$GNU_NEWLIB_INSTALL_DIR -DLLVM_PARALLEL_COMPILE_JOBS=4 \
  -DLLVM_PARALLEL_LINK_JOBS=1 -DLLVM_DEFAULT_TARGET_TRIPLE=riscv64-unknown-elf \
  -DDEFAULT_SYSROOT=$GNU_NEWLIB_INSTALL_DIR/riscv64-unknown-elf \
  -DLLVM_INSTALL_UTILS=ON ../llvm
  ninja
  ninja install
  popd
  rm -rf $LLVM_LINUX_BUILD_DIR
  mkdir $LLVM_LINUX_BUILD_DIR
  pushd $LLVM_LINUX_BUILD_DIR
  cmake -G &quot;Ninja&quot; -DCMAKE_BUILD_TYPE=Debug -DLLVM_TARGETS_TO_BUILD=&quot;RISCV&quot; \
  -DLLVM_ENABLE_PROJECTS=&quot;clang;lld&quot;  \
  -DLLVM_OPTIMIZED_TABLEGEN=On \
  -DCMAKE_INSTALL_PREFIX=$GNU_LINUX_INSTALL_DIR -DLLVM_PARALLEL_COMPILE_JOBS=4 \
  -DLLVM_PARALLEL_LINK_JOBS=1 -DLLVM_DEFAULT_TARGET_TRIPLE=riscv64-unknown-linux-gnu \
  -DDEFAULT_SYSROOT=$GNU_LINUX_INSTALL_DIR/sysroot -DLLVM_INSTALL_UTILS=ON ../llvm
  ninja
  ninja install
  popd
}

riscv_gnu_toolchain_prerequisites;
riscv_llvm_prerequisites;
get_llvm;
check;
build_gnu_toolchain;
build_llvm_toolchain;
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">pwd</span>
<span class="gp">$ </span><span class="nv">$HOME</span>/git/lbt/exlbt/riscv
<span class="gp">$ </span>bash riscv-toolchain-setup.sh
</pre></div>
</div>
<p>RISCV toolchain includes support for both bare-metal (Newlib) and Linux
platforms.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">pwd</span>
<span class="gp">$ </span><span class="nv">$HOME</span>/git/lbt/exlbt/riscv
<span class="gp">$ </span>ls <span class="nv">$HOME</span>/riscv/riscv_newlib
<span class="go">bin  include  lib  libexec  riscv64-unknown-elf  share</span>
</pre></div>
</div>
<figure class="align-center" id="id39">
<span id="riscv-f3"></span><a class="reference internal image-reference" href="_images/linux-sysroot.png"><img alt="_images/linux-sysroot.png" src="_images/linux-sysroot.png" style="width: 434.0px; height: 538.0px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 15 </span><span class="caption-text">RISCV ISA Description</span><a class="headerlink" href="#id39" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The Linux sysroot is shown in <a class="reference internal" href="#riscv-f3"><span class="std std-numref">Fig. 15</span></a> above.
You can compare it with the following installed directory.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls <span class="nv">$HOME</span>/riscv/riscv_linux/sysroot/
<span class="go">etc  lib  lib64  sbin  usr  var</span>
<span class="gp">$ </span>ls <span class="nv">$HOME</span>/riscv/riscv_linux/sysroot/usr
<span class="go">bin  include  lib  libexec  sbin  share</span>
</pre></div>
</div>
</section>
<section id="linker-command">
<h2><a class="toc-backref" href="#id45" role="doc-backlink">Linker Command</a><a class="headerlink" href="#linker-command" title="Permalink to this heading">¶</a></h2>
<p>Different HW platforms have their own memory map for the RISCV architecture.
As a result, their HW may need to initialize $sp, $pc, $gp, and others.
The GNU linker command language <a class="footnote-reference brackets" href="#ld-cl" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>15<span class="fn-bracket">]</span></a> allows users to specify the memory
map for their HW.</p>
<p>The crt0.S and riscv64-virt.ld in lbt/exlbt/riscv are modified from the original
as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">riscv$ pwd</span>
<span class="go">~/git/lbt/exlbt/riscv</span>
<span class="go">riscv$ diff exlbt/riscv/crt0.S ~/riscv/git/riscv-gnu-toolchain/newlib/libgloss/riscv/crt0.S</span>
<span class="go">22d21</span>
<span class="go">&lt;   la sp, __stack_top</span>
<span class="go">riscv$ ~/riscv/14.x/riscv_newlib/bin/riscv64-unknown-elf-ld --verbose &amp;&gt; riscv64-virt-origin.ld</span>
<span class="go">riscv$ diff riscv64-virt-origin.ld riscv64-virt.ld</span>
<span class="go">1,8d0</span>
<span class="go">&lt; GNU ld (GNU Binutils) 2.39</span>
<span class="go">&lt;   Supported emulations:</span>
<span class="go">&lt;    elf64lriscv</span>
<span class="go">&lt;    elf32lriscv</span>
<span class="go">&lt;    elf64briscv</span>
<span class="go">&lt;    elf32briscv</span>
<span class="go">&lt; using internal linker script:</span>
<span class="go">&lt; ==================================================</span>
<span class="go">16a9,12</span>
<span class="go">&gt; MEMORY</span>
<span class="go">&gt; {</span>
<span class="go">&gt;    RAM (rx)  : ORIGIN = 0x10000, LENGTH = 128M</span>
<span class="go">&gt; }</span>
<span class="go">22a19</span>
<span class="go">&gt;   PROVIDE(__stack_top = ORIGIN(RAM) + LENGTH(RAM));</span>
<span class="go">257,259d253</span>
<span class="go">&lt;</span>
<span class="go">&lt;</span>
<span class="go">&lt; ==================================================</span>
<span class="go">riscv$ ~/riscv/14.x/riscv_newlib/bin/clang hello.c -menable-experimental-extensions \</span>
<span class="go">-march=rv64gcv1p0 -O0 -mabi=lp64d -T riscv64-virt.ld -nostartfiles crt0.S -v</span>
</pre></div>
</div>
<p>If RAM is used with (rwx) permission, a warning may occur.
This warning can be suppressed by adding <cite>-Wl,–no-warn-rwx-segment</cite>
to the clang options.</p>
<p>QEMU in the next section can run the program without initializing $sp in crt0.S.
Perhaps QEMU initializes $sp as shown in the following code.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">qemu$ pwd</span>
<span class="go">~/riscv/git/qemu</span>
<span class="go">qemu$ vi linux-user/riscv/cpu_loop.c</span>
<span class="go">void target_cpu_copy_regs(CPUArchState *env, struct target_pt_regs *regs)</span>
<span class="go">{</span>
<span class="go">  ...</span>
<span class="go">  env-&gt;gpr[xSP] = regs-&gt;sp;</span>
</pre></div>
</div>
<p>The ELF object file format uses program headers, which the system loader reads
to know how to load the program into memory. The program headers of an ELF file
can be displayed using <cite>llvm-objdump -p</cite> <a class="footnote-reference brackets" href="#ld-ph" id="id8" role="doc-noteref"><span class="fn-bracket">[</span>16<span class="fn-bracket">]</span></a>.</p>
<p>The instruction “la sp, __stack_top” is a pseudo-instruction in RISCV <a class="footnote-reference brackets" href="#riscv-pseudo-inst" id="id9" role="doc-noteref"><span class="fn-bracket">[</span>17<span class="fn-bracket">]</span></a>.</p>
</section>
<section id="qemu-simulator">
<h2><a class="toc-backref" href="#id46" role="doc-backlink">QEMU simulator</a><a class="headerlink" href="#qemu-simulator" title="Permalink to this heading">¶</a></h2>
<p>Install QEMU following the instructions at:
<a class="reference external" href="https://gitlab.com/qemu-project/qemu">https://gitlab.com/qemu-project/qemu</a> as shown below.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">pwd</span>
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/git
<span class="gp">$ </span>git clone https://gitlab.com/qemu-project/qemu.git
<span class="gp">$ </span><span class="nb">cd</span> qemu
<span class="gp">$ </span>git log
<span class="go">commit a28498b1f9591e12dcbfdf06dc8f54e15926760e</span>
<span class="go">...</span>
<span class="gp">$ </span>mkdir build
<span class="gp">$ </span><span class="nb">cd</span> build
<span class="gp">$ </span>../configure
<span class="gp">$ </span>make
</pre></div>
</div>
<p>Then, you can compile and run QEMU for bare-metal as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">pwd</span>
<span class="gp">$ </span><span class="nv">$HOME</span>/git/lbt/exlbt/riscv
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/riscv_newlib/bin/clang -march<span class="o">=</span>rv64g hello.c -fuse-ld<span class="o">=</span>lld <span class="se">\</span>
  -mno-relax -g -mabi<span class="o">=</span>lp64d -o hello_newlib
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/git/qemu/build/qemu-riscv64 hello_newlib
<span class="go">hello world!</span>
</pre></div>
</div>
<p>Also, compile and run QEMU for Linux <a class="footnote-reference brackets" href="#riscv-build-linux" id="id10" role="doc-noteref"><span class="fn-bracket">[</span>18<span class="fn-bracket">]</span></a> as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nv">$HOME</span>/riscv/riscv_linux/bin/clang -march<span class="o">=</span>rv64g hello.c -o hello_linux -static
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/git/qemu/build/qemu-riscv64 hello_linux
<span class="go">hello world!</span>
</pre></div>
</div>
<p>RISCV requires linking with -lm for math.h functions, as shown below:</p>
<p class="rubric">exlbt/riscv/pow.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// RISCV does need -lm while X86-64 does not.
// $ ~/riscv/riscv_newlib/bin/clang++ -menable-experimental-extensions pow.cpp -march=rv64gcv0p10 -O0 -fuse-ld=lld -mno-relax -g -mabi=lp64d -lm  -v
// $ ~/riscv/git/qemu/build/qemu-riscv64 -cpu rv64,v=true a.out

#include &lt;stdio.h&gt;
#include &lt;math.h&gt;

double base = 100;
double power = 2;
double test_math()
{
  double res = 0;

  res = pow(base, power);

  return res;
}

int main() {
  double a = test_math();
  printf(&quot;a = %lf\n&quot;, a);
  return 0;
}
</pre></div>
</div>
<p>Assembly code of “Hello, World” can be compiled and run in bare-metal mode as
follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nv">$HOME</span>/riscv/riscv_newlib/bin/riscv64-unknown-elf-gcc -c hello_world.s
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/riscv_newlib/bin/riscv64-unknown-elf-ld hello_world.o -o hello_world
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/git/qemu/build/qemu-riscv64 hello_world
<span class="go">Hello World</span>
</pre></div>
</div>
<p>Linking between assembly code and C for bare-metal can be done as follows:</p>
<p class="rubric">exlbt/riscv/caller_hello.c</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/* ~/git/lbt/exlbt/riscv$ ~/riscv/riscv_newlib/bin/riscv64-unknown-elf-gcc -c func_hello_start.s 
~/git/lbt/exlbt/riscv$ ~/riscv/riscv_newlib/bin/riscv64-unknown-elf-gcc -c caller_hello.c 
~/git/lbt/exlbt/riscv$ ~/riscv/riscv_newlib/bin/riscv64-unknown-elf-ld caller_hello.o func_hello_start.o
~/git/lbt/exlbt/riscv$ ~/riscv/riscv_newlib/bin/riscv64-unknown-elf-ld caller_hello.o func_hello_start.o -o a.out
~/git/lbt/exlbt/riscv$ ~riscv/git/qemu/build/qemu-riscv64 a.out
Hello World
*/

extern void hello();

int main() {
  hello();
}
</pre></div>
</div>
<p class="rubric">exlbt/riscv/func_hello_start.s</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">section</span> <span class="o">.</span><span class="n">text</span>
<span class="o">.</span><span class="n">globl</span> <span class="n">hello</span>
<span class="n">hello</span><span class="p">:</span>

    <span class="n">li</span> <span class="n">a0</span><span class="p">,</span> <span class="mi">0</span>                    <span class="c1"># stdout</span>
<span class="mi">1</span><span class="p">:</span>  <span class="n">auipc</span> <span class="n">a1</span><span class="p">,</span> <span class="o">%</span><span class="n">pcrel_hi</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>    <span class="c1"># load msg(hi)</span>
    <span class="n">addi</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="o">%</span><span class="n">pcrel_lo</span><span class="p">(</span><span class="mi">1</span><span class="n">b</span><span class="p">)</span>  <span class="c1"># load msg(lo)</span>
    <span class="n">li</span> <span class="n">a2</span><span class="p">,</span> <span class="mi">12</span>                   <span class="c1"># length</span>
    <span class="n">li</span> <span class="n">a3</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">li</span> <span class="n">a7</span><span class="p">,</span> <span class="mi">64</span>                   <span class="c1"># _NR_sys_write</span>
    <span class="n">ecall</span>                       <span class="c1"># system call</span>

    <span class="n">li</span> <span class="n">a0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">li</span> <span class="n">a1</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">li</span> <span class="n">a2</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">li</span> <span class="n">a3</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">li</span> <span class="n">a7</span><span class="p">,</span> <span class="mi">93</span>                   <span class="c1"># _NR_sys_exit</span>
    <span class="n">ecall</span>                       <span class="c1"># system call</span>

<span class="n">loop</span><span class="p">:</span>
    <span class="n">j</span> <span class="n">loop</span>

<span class="o">.</span><span class="n">section</span> <span class="o">.</span><span class="n">rodata</span>
<span class="n">msg</span><span class="p">:</span>
    <span class="o">.</span><span class="n">string</span> <span class="s2">&quot;Hello World</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="o">.</span><span class="n">globl</span> <span class="n">_start</span>
<span class="n">_start</span><span class="p">:</span>
    <span class="n">call</span> <span class="n">main</span>
</pre></div>
</div>
</section>
<section id="gem5-simulator">
<h2><a class="toc-backref" href="#id47" role="doc-backlink">Gem5 Simulator</a><a class="headerlink" href="#gem5-simulator" title="Permalink to this heading">¶</a></h2>
<p>Build Gem5 according to the following steps:</p>
<p><a class="reference external" href="https://www.gem5.org/documentation/general_docs/building">https://www.gem5.org/documentation/general_docs/building</a> or
<a class="reference external" href="http://learning.gem5.org/book/part1/building.html#requirements-for-gem5">http://learning.gem5.org/book/part1/building.html#requirements-for-gem5</a></p>
<p>If you do not have <code class="docutils literal notranslate"><span class="pre">python3.x-config</span></code> on Ubuntu 18.04, as shown below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls /usr/bin/python*
<span class="go">... /usr/bin/python2.7-config</span>
</pre></div>
</div>
<p>Then install it using pip3 as follows <a class="footnote-reference brackets" href="#install-python3-config" id="id11" role="doc-noteref"><span class="fn-bracket">[</span>19<span class="fn-bracket">]</span></a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo apt install python3-pip
<span class="gp">$ </span>pip3 install scons
<span class="gp">$ </span>ls /usr/bin/python*
<span class="go">... /usr/bin/python3-config</span>
</pre></div>
</div>
<p>After installing all dependencies, clone gem5 and build the RISC-V target as
follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">pwd</span>
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/git
<span class="gp">$ </span>sudo apt install -y libglib2.0-dev
<span class="gp">$ </span>sudo apt install -y libpixman-1-dev
<span class="gp">$ </span>git clone https://gem5.googlesource.com/public/gem5
<span class="gp">$ </span><span class="nb">cd</span> gem5
<span class="gp">$ </span>git log
<span class="go">commit 846dcf0ba4eff824c295f06550b8673ff3f31314</span>
<span class="go">...</span>
<span class="gp">$</span>HOME/riscv/git/gem5$ /usr/bin/env python3 <span class="k">$(</span>which scons<span class="k">)</span> ./build/RISCV/gem5.debug -j4
<span class="go">...</span>
<span class="gp">$ </span><span class="nb">pwd</span>
<span class="gp">$ </span><span class="nv">$HOME</span>/git/lbt/exlbt/riscv
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/git/gem5/build/RISCV/gem5.debug <span class="se">\</span>
<span class="gp">$</span>HOME/riscv/git/gem5/configs/example/se.py --cmd<span class="o">=</span>./hello_newlib
<span class="go">**** REAL SIMULATION ****</span>
<span class="go">build/RISCV/sim/simulate.cc:107: info: Entering event queue @ 0.  Starting simulation...</span>
<span class="go">hello world!</span>
</pre></div>
</div>
<p>Check the number of cycles as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>HOME/git/lbt/exlbt/riscv$ vi m5out/stats.txt
<span class="go">simSeconds          0.000001       # Number of seconds simulated (Second)</span>
<span class="go">simTicks            1229000        # Number of ticks simulated (Tick)</span>
<span class="go">...</span>

<span class="gp">$</span>HOME/git/lbt/exlbt/riscv$ <span class="nv">$HOME</span>/riscv/git/gem5/build/RISCV/gem5.debug <span class="se">\</span>
/local/git/gem5/configs/example/se.py --cmd<span class="o">=</span>./hello_linux
<span class="go">...</span>
<span class="go">hello world!</span>
<span class="go">...</span>
</pre></div>
</div>
<p>The configuration examples for gem5 can be found at the following reference:
<a class="reference external" href="http://learning.gem5.org/book/part1/example_configs.html">http://learning.gem5.org/book/part1/example_configs.html</a></p>
</section>
<section id="gdb">
<h2><a class="toc-backref" href="#id48" role="doc-backlink">GDB</a><a class="headerlink" href="#gdb" title="Permalink to this heading">¶</a></h2>
<figure class="align-default" id="id40">
<span id="gdb-f"></span><div class="graphviz"><img src="_images/graphviz-22875f244fb6b57c0948c5ed480f623e2b2c6707.png" alt="digraph G {

  rankdir=LR;
  subgraph cluster_0 {
    style=filled;
    color=lightgrey;
//    label = &quot;GDB flow&quot;;
    node [style=filled,color=white]; user, gdb;
//    node [style=filled,color=white]; linker [label = &quot;lld or ld&quot;];
    node [style=filled,color=white]; simulator [label = &quot;qemu &quot;];
//    linker -&gt; simulator [ label = &quot;exe&quot; ];
//    linker -&gt; gdb [ label = &quot;exe&quot; ];
    user -&gt; gdb [label = &quot;debug command&quot;];
    gdb -&gt; simulator [label = &quot;debug command(print res, step, ...)&quot;];
    simulator -&gt; gdb [label = &quot;response(variable-value, ...)&quot;];
  }

}" class="graphviz" /></div>
<figcaption>
<p><span class="caption-number">Fig. 16 </span><span class="caption-text">GDB flow</span><a class="headerlink" href="#id40" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>LLVM 13.x fails to compile RVV C/C++ files with <cite>clang -g</cite>, while LLVM 14.x works.
Run QEMU on terminal A with GDB on terminal B as follows <a class="footnote-reference brackets" href="#riscv-qemu-gdb" id="id12" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">// terminal A:</span>
<span class="gp">$ </span><span class="nb">pwd</span>
<span class="gp">$ </span><span class="nv">$HOME</span>/git/lbt/exlbt/riscv
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/14.x/riscv_newlib/bin/clang vadd1.c -menable-experimental-extensions <span class="se">\</span>
  -march<span class="o">=</span>rv64gcv1p0 -O0 -g -mabi<span class="o">=</span>lp64d -o a.out  -v
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/git/qemu/build/qemu-riscv64 -cpu rv64,v<span class="o">=</span><span class="nb">true</span> -g <span class="m">1234</span> a.out
<span class="go">vector version is not specified, use the default value v1.0</span>

<span class="go">// terminal B:</span>
<span class="gp">$ </span><span class="nb">pwd</span>
<span class="gp">$ </span><span class="nv">$HOME</span>/git/lbt/exlbt/riscv
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/14.x/riscv_newlib/bin/riscv64-unknown-elf-gdb a.out
<span class="go">...</span>
<span class="go">Reading symbols from a.out...</span>
<span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">target remote :1234</span>
<span class="go">Remote debugging using :1234</span>
<span class="go">0x0000000000010150 in _start ()</span>
<span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">b vadd1.c:95</span>
<span class="go">Breakpoint 1 at 0x10536: file vadd1.c, line 95.</span>
<span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">c</span>
<span class="go">Continuing.</span>
<span class="go">Breakpoint 1, main () at vadd1.c:95</span>
<span class="go">95      vOp(a, a, a, array_size(a), VMUL);</span>
<span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">p a[1]</span>
<span class="gp">$</span><span class="nv">1</span> <span class="o">=</span> <span class="m">2</span>

<span class="go">// terminal A:</span>
<span class="go">...</span>
<span class="go">vl: 32</span>
<span class="go">array_size(a):4096</span>

<span class="go">a[]: 0 2 4 6 8 10 12 14 16 18 20 22 24 26 28 30 32 34 36 38 40 42 44 46 48 50</span>
<span class="go">52 54 56 58 60 62 64 66 68 70 72 74 76 78 80 82 84 86 88 90 92 94 96 98 100</span>
<span class="go">102 104 106 108 110 112 114 116 118 120 122 124 126 ...</span>
<span class="go">The results of VADD:  PASS</span>

<span class="go">// terminal B:</span>
<span class="gp">$ </span>...
<span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">c</span>

<span class="go">// terminal A:</span>
<span class="go">...</span>
<span class="go">a[]: 0 4 16 36 64 100 144 196 256 324 400 484 576 676 784 900 1024 1156 1296</span>
<span class="go">1444 1600 1764 1936 2116 2304 2500 2704 2916 3136 3364 3600 3844 4096 4356</span>
<span class="go">4624 4900 5184 5476 5776 6084 6400 6724 7056 7396 7744 8100 8464 8836 9216</span>
<span class="go">9604 10000 10404 10816 11236 11664 12100 12544 12996 13456 13924 14400 14884</span>
<span class="go">15376 15876 ...</span>
<span class="go">The results of VMUL:  PASS</span>
<span class="gp">$</span>
</pre></div>
</div>
<p>Since RVV v1.0 is accepted and v0.10 is draft for release v1.0, the above
-march option changed from <cite>rv64gv0p10</cite> in LLVM 13.x to <cite>rv64gcv1p0</cite> in LLVM
14.x <a class="footnote-reference brackets" href="#rvv-0p10-1p0" id="id13" role="doc-noteref"><span class="fn-bracket">[</span>8<span class="fn-bracket">]</span></a>.</p>
<p>In the example above, both QEMU and GDB run in the same host environment.</p>
<p>When you need more
flexibility–for example, running GDB on a physically separate host, or
controlling a standalone system over a serial port or a realtime system over a
TCP/IP connection <a class="footnote-reference brackets" href="#gdb-target" id="id14" role="doc-noteref"><span class="fn-bracket">[</span>9<span class="fn-bracket">]</span></a>. To use a TCP connection, use an argument of the
form host:port. Above “target remote :1234”, means host and target run on the same
host listening port 1234 <a class="footnote-reference brackets" href="#gdb-tcpip" id="id15" role="doc-noteref"><span class="fn-bracket">[</span>10<span class="fn-bracket">]</span></a>.</p>
</section>
<section id="riscv-calling-convention">
<h2><a class="toc-backref" href="#id49" role="doc-backlink">RISCV Calling Convention <a class="footnote-reference brackets" href="#calling-conv" id="id16" role="doc-noteref"><span class="fn-bracket">[</span>11<span class="fn-bracket">]</span></a></a><a class="headerlink" href="#riscv-calling-convention" title="Permalink to this heading">¶</a></h2>
<p>The RV32 register size is 32 bits. The RV64 register size is 64 bits.</p>
<p>In RV64, 32-bit types, such as int, are stored in integer registers with proper
sign extension; that is, bits 63..32 are copies of bit 31.</p>
<p>There are two kinds of ABI: ilp32 and lp64, such as -mabi=ilp32, ilp32f, ilp32d,
lp64, lp64f, lp64d. They differ in how float arguments are passed on integer,
single-float, or double-float registers.</p>
<table class="docutils align-default" id="id41">
<caption><span class="caption-number">Table 7 </span><span class="caption-text">ABI, caller passing integer/float/double arguments <a class="footnote-reference brackets" href="#calling-conv-1" id="id17" role="doc-noteref"><span class="fn-bracket">[</span>12<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#calling-conv-2" id="id18" role="doc-noteref"><span class="fn-bracket">[</span>13<span class="fn-bracket">]</span></a></span><a class="headerlink" href="#id41" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>name</p></th>
<th class="head"><p>float</p></th>
<th class="head"><p>double</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ilp32/lp64</p></td>
<td><p>a registers</p></td>
<td><p>a registers</p></td>
</tr>
<tr class="row-odd"><td><p>ilp32f/lp64f</p></td>
<td><p>fa registers</p></td>
<td><p>a regsiters</p></td>
</tr>
<tr class="row-even"><td><p>ilp32d/lp64d</p></td>
<td><p>fa registers</p></td>
<td><p>fa registers</p></td>
</tr>
</tbody>
</table>
<p>Both ilp32 and lp64 are Soft-Float Calling Conventions.</p>
<p>Soft-Float Calling Convention means floating-point arguments are passed and
returned <strong>in integer registers</strong>, using the same rules as integer arguments
of the corresponding size.</p>
<ul>
<li><p>-mabi=ABI-string</p>
<p>Specify integer and floating-point calling convention. ABI-string contains
two parts: the size of integer types and the registers used for floating-point
types. For example ‘-march=rv64ifd -mabi=lp64d’ means that ‘long’ and pointers
are 64-bit (implicitly defining ‘int’ to be 32-bit), and that floating-point
values up to 64 bits wide are passed in F registers. Contrast this with
‘-march=rv64ifd -mabi=lp64f’, which still allows the compiler to generate code
that uses the F and D extensions but only allows floating-point values up to 32
bits long to be passed in registers; or ‘-march=rv64ifd -mabi=lp64’, in which
no floating-point arguments will be passed in registers.</p>
<p>The default for this argument is system dependent, users who want a specific
calling convention should specify one explicitly. The valid calling conventions
are: ‘ilp32’, ‘ilp32f’, ‘ilp32d’, ‘lp64’, ‘lp64f’, and ‘lp64d’. Some calling
conventions are impossible to implement on some ISAs: for example,
‘-march=rv32if -mabi=ilp32d’ is invalid because the ABI requires 64-bit values
be passed in F registers, but F registers are only 32 bits wide. There is also
the ‘ilp32e’ ABI that can only be used with the ‘rv32e’ architecture. This ABI
is not well specified at present, and is subject to change <a class="footnote-reference brackets" href="#gnu-riscv-options" id="id19" role="doc-noteref"><span class="fn-bracket">[</span>14<span class="fn-bracket">]</span></a>.</p>
</li>
</ul>
</section>
<section id="rvv">
<h2><a class="toc-backref" href="#id50" role="doc-backlink">RVV</a><a class="headerlink" href="#rvv" title="Permalink to this heading">¶</a></h2>
<p>Clang/LLVM provides RVV (RISC-V Vectors) written in C rather than inline assembly.</p>
<p>Although enabled by the clang option <cite>-target-feature +experimental-v</cite>, using C
is shorter, more user-friendly, and easier to remember than inline assembly.</p>
<p>Builtins are C functions and also user-friendly. RVV code can be written and
run as follows,</p>
<p class="rubric">exlbt/riscv/vadd2.c</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="k">pass</span><span class="p">:</span> 
<span class="o">/*</span> <span class="o">~/</span><span class="n">riscv</span><span class="o">/</span><span class="n">riscv_newlib</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">clang</span><span class="o">++</span> <span class="n">vadd2</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">menable</span><span class="o">-</span><span class="n">experimental</span><span class="o">-</span><span class="n">extensions</span> \
 <span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">rv64gcv0p10</span> <span class="o">-</span><span class="n">O0</span> <span class="o">-</span><span class="n">mllvm</span> <span class="o">--</span><span class="n">riscv</span><span class="o">-</span><span class="n">v</span><span class="o">-</span><span class="n">vector</span><span class="o">-</span><span class="n">bits</span><span class="o">-</span><span class="nb">min</span><span class="o">=</span><span class="mi">256</span> <span class="o">-</span><span class="n">v</span> <span class="o">*/</span>
<span class="o">//</span> <span class="o">~/</span><span class="n">riscv</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">qemu</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">qemu</span><span class="o">-</span><span class="n">riscv64</span> <span class="o">-</span><span class="n">cpu</span> <span class="n">rv64</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">true</span> <span class="n">a</span><span class="o">.</span><span class="n">out</span>
<span class="o">//</span> <span class="n">ref</span><span class="o">.</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">jia</span><span class="o">.</span><span class="n">je</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="mi">2022</span><span class="o">/</span><span class="mi">01</span><span class="o">/</span><span class="mi">25</span><span class="o">/</span><span class="n">rvv</span><span class="o">-</span><span class="mf">1.0</span><span class="o">-</span><span class="n">toolchain</span><span class="o">/</span>
<span class="o">//</span>      <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">pages</span><span class="o">.</span><span class="n">dogdog</span><span class="o">.</span><span class="n">run</span><span class="o">/</span><span class="n">toolchain</span><span class="o">/</span><span class="n">riscv_vector_extension</span><span class="o">.</span><span class="n">html</span>

<span class="c1">#include &lt;assert.h&gt;</span>
<span class="c1">#include &lt;stddef.h&gt;</span>
<span class="c1">#include &lt;stdint.h&gt;</span>
<span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &lt;riscv_vector.h&gt;</span>

<span class="c1">#define array_size(a) (sizeof(a) / sizeof((a)[0]))</span>

<span class="o">//</span> <span class="n">Vector</span><span class="o">-</span><span class="n">vector</span> <span class="n">add</span>
<span class="n">void</span> <span class="n">vadd</span><span class="p">(</span><span class="n">uint32_t</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">const</span> <span class="n">uint32_t</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">const</span> <span class="n">uint32_t</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">size_t</span> <span class="n">vl</span> <span class="o">=</span> <span class="n">vsetvl_e32m8</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="n">vuint32m8_t</span> <span class="n">vb</span> <span class="o">=</span> <span class="n">vle32_v_u32m8</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
<span class="o">//</span> <span class="n">generate</span><span class="p">:</span>
<span class="o">//</span>   <span class="n">vsetvli</span> <span class="n">zero</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">e32</span><span class="p">,</span> <span class="n">m8</span><span class="p">,</span> <span class="n">ta</span><span class="p">,</span> <span class="n">mu</span>
<span class="o">//</span>   <span class="n">vadd</span><span class="o">.</span><span class="n">vv</span> <span class="n">v8</span><span class="p">,</span> <span class="n">v8</span><span class="p">,</span> <span class="n">v16</span>
    <span class="n">vuint32m8_t</span> <span class="n">vc</span> <span class="o">=</span> <span class="n">vle32_v_u32m8</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">vuint32m8_t</span> <span class="n">va</span> <span class="o">=</span> <span class="n">vadd</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">vse32</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vl</span><span class="p">);</span>
    <span class="n">a</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">n</span> <span class="o">-=</span> <span class="n">vl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Vector</span><span class="o">-</span><span class="n">vector</span> <span class="n">add</span> <span class="p">(</span><span class="n">inline</span> <span class="n">assembly</span><span class="p">)</span>
<span class="n">void</span> <span class="n">vadd_asm</span><span class="p">(</span><span class="n">uint32_t</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">const</span> <span class="n">uint32_t</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">const</span> <span class="n">uint32_t</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">size_t</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">vuint32m8_t</span> <span class="n">va</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">vc</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Fail</span><span class="p">:</span> <span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span> <span class="s2">&quot;vsetvli %[vl], %[512], e32, m8&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">vl</span><span class="p">]</span> <span class="s2">&quot;=r&quot;</span><span class="p">(</span><span class="n">vl</span><span class="p">)</span> <span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">]</span> <span class="s2">&quot;r&quot;</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">vl</span> <span class="o">=</span> <span class="n">vsetvl_e32m8</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="c1">#if (__clang_major__ &gt; 10)</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span> <span class="s2">&quot;vle32.v %[vb], (%[b])&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">vb</span><span class="p">]</span> <span class="s2">&quot;=vr&quot;</span><span class="p">(</span><span class="n">vb</span><span class="p">)</span> <span class="p">:</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="s2">&quot;r&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">:</span> <span class="s2">&quot;memory&quot;</span> <span class="p">);</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span> <span class="s2">&quot;vle32.v %[vc], (%[c])&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">vc</span><span class="p">]</span> <span class="s2">&quot;=vr&quot;</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span> <span class="p">:</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="s2">&quot;r&quot;</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">:</span> <span class="s2">&quot;memory&quot;</span> <span class="p">);</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span> <span class="s2">&quot;vadd.vv %[va], %[vb], %[vc]&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">va</span><span class="p">]</span> <span class="s2">&quot;=vr&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">)</span> <span class="p">:</span> <span class="p">[</span><span class="n">vb</span><span class="p">]</span> <span class="s2">&quot;vr&quot;</span><span class="p">(</span><span class="n">vb</span><span class="p">),</span> <span class="p">[</span><span class="n">vc</span><span class="p">]</span> <span class="s2">&quot;vr&quot;</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span> <span class="s2">&quot;vse32.v %[va], (%[a])&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">va</span><span class="p">]</span> <span class="s2">&quot;=vr&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">)</span> <span class="p">:</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="s2">&quot;r&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">:</span> <span class="s2">&quot;memory&quot;</span> <span class="p">);</span>
<span class="c1">#else</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span> <span class="s2">&quot;vle32.v %[vb], (%[b])&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">vb</span><span class="p">]</span> <span class="s2">&quot;=v8&quot;</span><span class="p">(</span><span class="n">vb</span><span class="p">)</span> <span class="p">:</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="s2">&quot;r&quot;</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">:</span> <span class="s2">&quot;memory&quot;</span> <span class="p">);</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span> <span class="s2">&quot;vle32.v %[vc], (%[c])&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">vc</span><span class="p">]</span> <span class="s2">&quot;=v8&quot;</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span> <span class="p">:</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="s2">&quot;r&quot;</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">:</span> <span class="s2">&quot;memory&quot;</span> <span class="p">);</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span> <span class="s2">&quot;vadd.vv %[va], %[vb], %[vc]&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">va</span><span class="p">]</span> <span class="s2">&quot;=v8&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">)</span> <span class="p">:</span> <span class="p">[</span><span class="n">vb</span><span class="p">]</span> <span class="s2">&quot;v8&quot;</span><span class="p">(</span><span class="n">vb</span><span class="p">),</span> <span class="p">[</span><span class="n">vc</span><span class="p">]</span> <span class="s2">&quot;v8&quot;</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span> <span class="s2">&quot;vse32.v %[va], (%[a])&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">va</span><span class="p">]</span> <span class="s2">&quot;=v8&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">)</span> <span class="p">:</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="s2">&quot;r&quot;</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">:</span> <span class="s2">&quot;memory&quot;</span> <span class="p">);</span>
<span class="c1">#endif</span>

    <span class="n">a</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">+=</span> <span class="n">vl</span><span class="p">;</span>
    <span class="n">n</span> <span class="o">-=</span> <span class="n">vl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">uint32_t</span> <span class="n">a</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
<span class="n">uint8_t</span> <span class="n">m</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="n">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;array_size(a):</span><span class="si">%lu</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">array_size</span><span class="p">(</span><span class="n">a</span><span class="p">));</span>
  <span class="o">//</span> <span class="n">init</span> <span class="n">source</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">array_size</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">vadd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">array_size</span><span class="p">(</span><span class="n">a</span><span class="p">));</span>

  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">a[]: &quot;</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">array_size</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
      <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>
      <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">);</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The results of vadd:</span><span class="se">\t</span><span class="s2">PASS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>

  <span class="n">vadd_asm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">array_size</span><span class="p">(</span><span class="n">a</span><span class="p">));</span>

  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">a[]: &quot;</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">array_size</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
      <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>
      <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">);</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The results of vadd_asm:</span><span class="se">\t</span><span class="s2">PASS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">pwd</span>
<span class="gp">$ </span><span class="nv">$HOME</span>/git/lbt/exlbt/riscv
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/riscv_newlib/bin/clang vadd2.c -menable-experimental-extensions <span class="se">\</span>
  -march<span class="o">=</span>rv64gcv0p10 -O0 -mllvm --riscv-v-vector-bits-min<span class="o">=</span><span class="m">256</span>
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/git/qemu/build/qemu-riscv64 -cpu rv64,v<span class="o">=</span><span class="nb">true</span> a.out
<span class="go">vector version is not specified, use the default value v1.0</span>
<span class="go">array_size(a):4096</span>

<span class="go">a[]: 0 2 4 6 8 10 12 14 16 18 ...</span>
<span class="go">The results of vadd:  PASS</span>

<span class="go">a[]: 0 4 8 12 16 20 24 28 32 36 ...</span>
<span class="go">The results of vadd_asm:      PASS</span>

<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/riscv_newlib/bin/clang vadd1.c -menable-experimental-extensions <span class="se">\</span>
  -march<span class="o">=</span>rv64gcv0p10 -O0 -mllvm --riscv-v-vector-bits-min<span class="o">=</span><span class="m">256</span> -static
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/git/qemu/build/qemu-riscv64 -cpu rv64,v<span class="o">=</span><span class="nb">true</span> a.out
<span class="go">vector version is not specified, use the default value v1.0</span>
<span class="go">1 11 11 11 11 11 11 11 11 1</span>
<span class="gp">$ </span><span class="nv">$HOME</span>/riscv/riscv_newlib/bin/riscv64-unknown-elf-objdump -d a.out<span class="p">|</span>grep vadd.vv
<span class="go"> 106fc:       03ae0d57                vadd.vv v26,v26,v28</span>
</pre></div>
</div>
<p>For <cite>-march=rv64imfv0p10zfh0p1</cite>,</p>
<ul class="simple">
<li><p><cite>v0p10</cite>: vector version 0.10.</p></li>
<li><p><cite>zfh0p1</cite>: “Zfh” version 0.1 <a class="footnote-reference brackets" href="#rre" id="id20" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>.</p></li>
</ul>
<p>For <cite>-mabi</cite>, see the section above.</p>
<p>Clang/LLVM provides builtin and intrinsic functions to implement RVV (RISC-V
Vectors).</p>
<p class="rubric">$HOME/riscv/git/llvm-project/clang/include/clang/Basic/riscv_vector.td</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#define vsetvl_e8mf8(avl) __builtin_rvv_vsetvli((size_t)(avl), 0, 5)</span>
<span class="p">...</span><span class="w"></span>
<span class="n">defm</span><span class="w"> </span><span class="n">vmadd</span><span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">RVVIntTerBuiltinSet</span><span class="p">;</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="n">defm</span><span class="w"> </span><span class="n">vfdiv</span><span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">RVVFloatingBinBuiltinSet</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">$HOME/riscv/git/llvm-project/llvm/include/llvm/IR/IntrinsicsRISCV.td</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">def</span><span class="w"> </span><span class="n">int_riscv_vsetvli</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="n">Intrinsic</span><span class="o">&lt;</span><span class="p">...</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="n">defm</span><span class="w"> </span><span class="n">vmadd</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">RISCVTernaryAAXA</span><span class="p">;</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="n">defm</span><span class="w"> </span><span class="n">vfdiv</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">RISCVBinaryAAX</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Refer to Clang/LLVM test cases in the following folders.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>HOME/riscv/git/llvm-project/clang/test/CodeGen/RISCV/rvv-intrinsics$ ls
<span class="go">... vfdiv.c ... vfmadd.c</span>

<span class="gp">$</span>HOME/riscv/git/llvm-project/llvm/test/CodeGen/RISCV/rvv$ ls
<span class="go">... vfdiv-rv64.ll ... vfmadd-rv64.ll ...</span>
</pre></div>
</div>
</section>
<section id="atomic-instructions">
<h2><a class="toc-backref" href="#id51" role="doc-backlink">Atomic instructions</a><a class="headerlink" href="#atomic-instructions" title="Permalink to this heading">¶</a></h2>
<p>RISCV atomic instructions <a class="footnote-reference brackets" href="#atomic-isa" id="id21" role="doc-noteref"><span class="fn-bracket">[</span>20<span class="fn-bracket">]</span></a>.</p>
</section>
<section id="riscv-npu-for-deep-learning">
<h2><a class="toc-backref" href="#id52" role="doc-backlink">RISCV+NPU for Deep Learning</a><a class="headerlink" href="#riscv-npu-for-deep-learning" title="Permalink to this heading">¶</a></h2>
<p><a class="reference external" href="https://github.com/Jonathan2251/lbt/blob/master/present/AnLLVMBasedNPUCompiler.pdf">https://github.com/Jonathan2251/lbt/blob/master/present/AnLLVMBasedNPUCompiler.pdf</a></p>
</section>
<section id="resources">
<h2><a class="toc-backref" href="#id53" role="doc-backlink">Resources</a><a class="headerlink" href="#resources" title="Permalink to this heading">¶</a></h2>
<section id="freebsd">
<h3><a class="toc-backref" href="#id54" role="doc-backlink">FreeBSD</a><a class="headerlink" href="#freebsd" title="Permalink to this heading">¶</a></h3>
<p>FreeBSD RISCV <a class="footnote-reference brackets" href="#freebsd-platforms" id="id22" role="doc-noteref"><span class="fn-bracket">[</span>21<span class="fn-bracket">]</span></a>. FreeBSD <a class="footnote-reference brackets" href="#id34" id="id23" role="doc-noteref"><span class="fn-bracket">[</span>22<span class="fn-bracket">]</span></a>.</p>
</section>
<section id="freertos">
<h3><a class="toc-backref" href="#id55" role="doc-backlink">FreeRTOS</a><a class="headerlink" href="#freertos" title="Permalink to this heading">¶</a></h3>
<p>Code <a class="footnote-reference brackets" href="#freertos-github-riscv" id="id24" role="doc-noteref"><span class="fn-bracket">[</span>23<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#freertos-kernel" id="id25" role="doc-noteref"><span class="fn-bracket">[</span>24<span class="fn-bracket">]</span></a>. Documents <a class="footnote-reference brackets" href="#freertos-riscv-doc1" id="id26" role="doc-noteref"><span class="fn-bracket">[</span>25<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#freertos-pdf" id="id27" role="doc-noteref"><span class="fn-bracket">[</span>26<span class="fn-bracket">]</span></a>.</p>
</section>
<section id="zephyr">
<h3><a class="toc-backref" href="#id56" role="doc-backlink">Zephyr</a><a class="headerlink" href="#zephyr" title="Permalink to this heading">¶</a></h3>
<p>RISCV Boards <a class="footnote-reference brackets" href="#zephyr-riscv" id="id28" role="doc-noteref"><span class="fn-bracket">[</span>27<span class="fn-bracket">]</span></a>.</p>
</section>
<section id="andes">
<h3><a class="toc-backref" href="#id57" role="doc-backlink">Andes</a><a class="headerlink" href="#andes" title="Permalink to this heading">¶</a></h3>
<p>Amazon-FreeRTOS <a class="footnote-reference brackets" href="#andes-amazon-freertos" id="id29" role="doc-noteref"><span class="fn-bracket">[</span>28<span class="fn-bracket">]</span></a>, Xilinux has RISCV inside in MicroZed <a class="footnote-reference brackets" href="#microzed" id="id30" role="doc-noteref"><span class="fn-bracket">[</span>29<span class="fn-bracket">]</span></a> and vivado <a class="footnote-reference brackets" href="#vivado-riscv" id="id31" role="doc-noteref"><span class="fn-bracket">[</span>30<span class="fn-bracket">]</span></a>.</p>
<p>Zephyr <a class="footnote-reference brackets" href="#andes-zephyr" id="id32" role="doc-noteref"><span class="fn-bracket">[</span>31<span class="fn-bracket">]</span></a> .</p>
</section>
</section>
<section id="websites">
<h2><a class="toc-backref" href="#id58" role="doc-backlink">Websites</a><a class="headerlink" href="#websites" title="Permalink to this heading">¶</a></h2>
<p><a class="reference external" href="https://twilco.github.io/riscv-from-scratch/2019/04/27/riscv-from-scratch-2.html">https://twilco.github.io/riscv-from-scratch/2019/04/27/riscv-from-scratch-2.html</a></p>
<p><a class="reference external" href="https://twilco.github.io">https://twilco.github.io</a></p>
</section>
<section id="to-do">
<h2><a class="toc-backref" href="#id59" role="doc-backlink">To do:</a><a class="headerlink" href="#to-do" title="Permalink to this heading">¶</a></h2>
<p>As in exlbt/riscv/riscv-toolchain-setup-macos-intel.sh,
this script currently completes building both riscv_newlib and riscv_linux.</p>
<p>However, qemu does not create qemu-riscv64 for baremetal on macOS,
so verification cannot be done yet.</p>
<ul>
<li><p>How to run qemu-system-riscv64 as baremetal qemu-riscv64?</p>
<p>Following <a class="reference external" href="https://twilco.github.io/riscv-from-scratch/2019/04/27/riscv-from-scratch-2.html#link-it-up">https://twilco.github.io/riscv-from-scratch/2019/04/27/riscv-from-scratch-2.html#link-it-up</a>
to create crt0.S and riscv64-virt.ld does not work.
It fails without changing crt0.S as well.</p>
</li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">// terminal A:</span>
<span class="go">riscv % ~/riscv/14.x/riscv_newlib/bin/clang hello.c -menable-experimental-extensions \</span>
<span class="go">-march=rv64gcv1p0 -O0 -mabi=lp64d -T riscv64-virt.ld -Wl,--no-warn-rwx-segment -nostartfiles crt0.S -v</span>
<span class="go">riscv % ~/riscv/git/qemu/build/qemu-system-riscv64 -machine virt -m 128M -cpu \</span>
<span class="go">rv64,v=true -gdb tcp::1234 -kernel a.out</span>

<span class="go">// terminal B:</span>
<span class="go">riscv % ~/riscv/14.x/riscv_newlib/bin/riscv64-unknown-elf-gdb a.out</span>
<span class="go">...</span>
<span class="go">Reading symbols from a.out...</span>
<span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">target remote :1234</span>
<span class="go">Remote debugging using :1234</span>
<span class="go">0x0000000080000408 in ?? ()</span>
<span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">c</span>
<span class="go">Continuing.</span>
</pre></div>
</div>
<p>The qemu-system-riscv64 with -nographic option also fails to run properly.</p>
<aside class="footnote brackets" id="toolchain" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>Reference “Table 1 Toolchain components” of <a class="reference external" href="http://jonathan2251.github.io/lbt/about.html#outline-of-chapters">http://jonathan2251.github.io/lbt/about.html#outline-of-chapters</a></p>
</aside>
<aside class="footnote brackets" id="id33" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://riscv.org/technical/specifications/">https://riscv.org/technical/specifications/</a></p>
</aside>
<aside class="footnote brackets" id="riscv-wiki" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/RISC-V">https://en.wikipedia.org/wiki/RISC-V</a></p>
</aside>
<aside class="footnote brackets" id="rre" role="note">
<span class="label"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id4">1</a>,<a role="doc-backlink" href="#id20">2</a>)</span>
<p><a class="reference external" href="https://wiki.riscv.org/display/HOME/Recently+Ratified+Extensions">https://wiki.riscv.org/display/HOME/Recently+Ratified+Extensions</a></p>
</aside>
<aside class="footnote brackets" id="endians-format" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">5</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.technicalsourcery.net/posts/on-endianness">https://www.technicalsourcery.net/posts/on-endianness</a></p>
</aside>
<aside class="footnote brackets" id="andes-ilm" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">6</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="http://www.andestech.com/en/products-solutions/andescore-processors/riscv-n25f/">http://www.andestech.com/en/products-solutions/andescore-processors/riscv-n25f/</a> ,
<a class="reference external" href="http://www.andestech.com/en/products-solutions/andestar-architecture/">http://www.andestech.com/en/products-solutions/andestar-architecture/</a></p>
</aside>
<aside class="footnote brackets" id="riscv-qemu-gdb" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id12">7</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://danielmangum.com/posts/risc-v-bytes-qemu-gdb/">https://danielmangum.com/posts/risc-v-bytes-qemu-gdb/</a></p>
</aside>
<aside class="footnote brackets" id="rvv-0p10-1p0" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id13">8</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://github.com/riscv/riscv-v-spec/releases">https://github.com/riscv/riscv-v-spec/releases</a></p>
</aside>
<aside class="footnote brackets" id="gdb-target" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id14">9</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://ftp.gnu.org/old-gnu/Manuals/gdb/html_chapter/gdb_15.html#SEC125">https://ftp.gnu.org/old-gnu/Manuals/gdb/html_chapter/gdb_15.html#SEC125</a></p>
</aside>
<aside class="footnote brackets" id="gdb-tcpip" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id15">10</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://ftp.gnu.org/old-gnu/Manuals/gdb/html_chapter/gdb_15.html#SEC133">https://ftp.gnu.org/old-gnu/Manuals/gdb/html_chapter/gdb_15.html#SEC133</a></p>
</aside>
<aside class="footnote brackets" id="calling-conv" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id16">11</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://riscv.org/wp-content/uploads/2015/01/riscv-calling.pdf">https://riscv.org/wp-content/uploads/2015/01/riscv-calling.pdf</a></p>
</aside>
<aside class="footnote brackets" id="calling-conv-1" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id17">12</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://blog.csdn.net/zoomdy/article/details/79353313">https://blog.csdn.net/zoomdy/article/details/79353313</a></p>
</aside>
<aside class="footnote brackets" id="calling-conv-2" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id18">13</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://wiki.gentoo.org/wiki/RISC-V_ABIs">https://wiki.gentoo.org/wiki/RISC-V_ABIs</a></p>
</aside>
<aside class="footnote brackets" id="gnu-riscv-options" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id19">14</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://gcc.gnu.org/onlinedocs/gcc/RISC-V-Options.html">https://gcc.gnu.org/onlinedocs/gcc/RISC-V-Options.html</a></p>
</aside>
<aside class="footnote brackets" id="ld-cl" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">15</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_chapter/ld_3.html">https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_chapter/ld_3.html</a></p>
</aside>
<aside class="footnote brackets" id="ld-ph" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id8">16</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_chapter/ld_3.html#SEC23">https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_chapter/ld_3.html#SEC23</a></p>
</aside>
<aside class="footnote brackets" id="riscv-pseudo-inst" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id9">17</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://github.com/riscv-non-isa/riscv-asm-manual/blob/master/riscv-asm.md#-a-listing-of-standard-risc-v-pseudoinstructions">https://github.com/riscv-non-isa/riscv-asm-manual/blob/master/riscv-asm.md#-a-listing-of-standard-risc-v-pseudoinstructions</a></p>
</aside>
<aside class="footnote brackets" id="riscv-build-linux" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id10">18</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://github.com/riscv-collab/riscv-gnu-toolchain/issues/644">https://github.com/riscv-collab/riscv-gnu-toolchain/issues/644</a></p>
</aside>
<aside class="footnote brackets" id="install-python3-config" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id11">19</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.anycodings.com/questions/gem5-build-fails-with-embedded-python-library-36-or-newer-required-found-2717">https://www.anycodings.com/questions/gem5-build-fails-with-embedded-python-library-36-or-newer-required-found-2717</a></p>
</aside>
<aside class="footnote brackets" id="atomic-isa" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id21">20</a><span class="fn-bracket">]</span></span>
<p>Chapter 8 of Volume 1, Unprivileged Spec v. 20191213 <a class="reference external" href="https://five-embeddev.com/riscv-isa-manual/latest/a.html">https://five-embeddev.com/riscv-isa-manual/latest/a.html</a></p>
</aside>
<aside class="footnote brackets" id="freebsd-platforms" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id22">21</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.freebsd.org/platforms/">https://www.freebsd.org/platforms/</a></p>
</aside>
<aside class="footnote brackets" id="id34" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id23">22</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://github.com/freebsd">https://github.com/freebsd</a></p>
</aside>
<aside class="footnote brackets" id="freertos-github-riscv" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id24">23</a><span class="fn-bracket">]</span></span>
<p>In <a class="reference external" href="https://github.com/FreeRTOS/FreeRTOS/tree/main/FreeRTOS/Demo">https://github.com/FreeRTOS/FreeRTOS/tree/main/FreeRTOS/Demo</a>, directories RISC-V*</p>
</aside>
<aside class="footnote brackets" id="freertos-kernel" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id25">24</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://github.com/FreeRTOS/FreeRTOS-Kernel.git">https://github.com/FreeRTOS/FreeRTOS-Kernel.git</a></p>
</aside>
<aside class="footnote brackets" id="freertos-riscv-doc1" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id26">25</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.freertos.org/Using-FreeRTOS-on-RISC-V.html">https://www.freertos.org/Using-FreeRTOS-on-RISC-V.html</a></p>
</aside>
<aside class="footnote brackets" id="freertos-pdf" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id27">26</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.freertos.org/fr-content-src/uploads/2018/07/161204_Mastering_the_FreeRTOS_Real_Time_Kernel-A_Hands-On_Tutorial_Guide.pdf">https://www.freertos.org/fr-content-src/uploads/2018/07/161204_Mastering_the_FreeRTOS_Real_Time_Kernel-A_Hands-On_Tutorial_Guide.pdf</a></p>
</aside>
<aside class="footnote brackets" id="zephyr-riscv" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id28">27</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://docs.zephyrproject.org/3.1.0/boards/riscv/index.html">https://docs.zephyrproject.org/3.1.0/boards/riscv/index.html</a></p>
</aside>
<aside class="footnote brackets" id="andes-amazon-freertos" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id29">28</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://github.com/andestech/amazon-freertos">https://github.com/andestech/amazon-freertos</a></p>
</aside>
<aside class="footnote brackets" id="microzed" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id30">29</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.xilinx.com/about/blogs/adaptable-advantage-blog/2021/MicroZed-Chronicles--Bluespec-RISC-V.html">https://www.xilinx.com/about/blogs/adaptable-advantage-blog/2021/MicroZed-Chronicles–Bluespec-RISC-V.html</a></p>
</aside>
<aside class="footnote brackets" id="vivado-riscv" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id31">30</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://github.com/eugene-tarassov/vivado-risc-v">https://github.com/eugene-tarassov/vivado-risc-v</a></p>
</aside>
<aside class="footnote brackets" id="andes-zephyr" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id32">31</a><span class="fn-bracket">]</span></span>
<p>Andes Zephyr port supports SMP (Symmetric Multi-Processing) and has been verified on Andes RISC-V multicore. <a class="reference external" href="https://www.globenewswire.com/news-release/2021/04/23/2216131/0/en/Andes-Announces-the-New-Upgrade-of-AndeSight-IDE-v5-0-a-comprehensive-software-solution-to-accelerate-RISC-V-AI-and-IoT-developments.html">https://www.globenewswire.com/news-release/2021/04/23/2216131/0/en/Andes-Announces-the-New-Upgrade-of-AndeSight-IDE-v5-0-a-comprehensive-software-solution-to-accelerate-RISC-V-AI-and-IoT-developments.html</a></p>
</aside>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="lldb.html">LLDB</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="clang-tools.html">Appendix B: Clang library and tools</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Chen Chung-Shu.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>