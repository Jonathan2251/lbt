
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Library &#8212; Tutorial: Creating an LLVM Toolchain for the Cpu0 Architecture</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/haiku.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Optimization" href="opt.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Toolchain for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Library</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="opt.html">Optimization</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="library">
<span id="sec-lib"></span><h1>Library<a class="headerlink" href="#library" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#compiler-rt" id="id8">Compiler-rt</a></p></li>
<li><p><a class="reference internal" href="#avr-libc" id="id9">Avr libc</a></p></li>
<li><p><a class="reference internal" href="#software-float-point-support" id="id10">Software Float Point Support</a></p></li>
</ul>
</div>
<p>Since Cpu0 has not hardware float point instructions, it needs soft float point
library to finish the floating point operation. LLVM compiler-rt project include
the software floating point library implementation, so we choose it as the
implementation.</p>
<p>Since compiler-rt uses unix/linux rootfs structure, we fill the gap by porting
avr libc.</p>
<p>Both the compiler-rt and avr libc porting is under going, it’s not finished.
The flow as follows,</p>
<figure class="align-center" id="id7">
<span id="lib-f-flow"></span><a class="reference internal image-reference" href="_images/1.png"><img alt="_images/1.png" src="_images/1.png" style="width: 843.0px; height: 103.0px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 6 </span><span class="caption-text">libc/softfloat library flow</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The llvm-link which introduced at last chapter can be hired for optimization.</p>
<section id="compiler-rt">
<h2><a class="toc-backref" href="#id8">Compiler-rt</a><a class="headerlink" href="#compiler-rt" title="Permalink to this headline">¶</a></h2>
<p>Directory libex/libsoftfloat/compiler-rt include the floating point library
support for Cpu0 backend. The compiler-rt <a class="footnote-reference brackets" href="#id6" id="id1">1</a> version we use is
llvm 3.5 release.</p>
<p>The code modified as follows,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">chungshu@ChungShudeMacBook-Air compiler-rt % </span>diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/ builtins/ <span class="p">&amp;</span>&gt; compiler-rt-diff.patch
</pre></div>
</div>
<p class="rubric">lbt/Fig/compiler-rt-diff.patch</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Only in builtins/: Makefile
diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/absvdi2.c builtins/absvdi2.c
--- /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/absvdi2.c	2014-02-14 17:20:33.000000000 +0800
+++ builtins/absvdi2.c	2021-12-11 22:37:27.000000000 +0800
@@ -21,9 +21,26 @@
 COMPILER_RT_ABI di_int
 __absvdi2(di_int a)
 {
+#if 1
     const int N = (int)(sizeof(di_int) * CHAR_BIT);
     if (a == ((di_int)1 &lt;&lt; (N-1)))
         compilerrt_abort();
     const di_int t = a &gt;&gt; (N - 1);
     return (a ^ t) - t;
+#else
+  // Fix for Cpu0, Not OK!
+    di_int result;
+    const int N = (int)(sizeof(di_int) * CHAR_BIT);
+    if (a == (1 &lt;&lt; (N-1))) {
+    // In 2&#39;s compliment, positive only reach (power(2, N-1) - 1)
+        compilerrt_abort();
+    }
+    const di_int t = (1 &lt;&lt; (N-1));
+    if ((a &amp; t) == t)
+      // negative, t = 0x8000...0
+      result = 0 - a;
+    else
+      result = a;
+    return result;
+#endif
 }
diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/absvsi2.c builtins/absvsi2.c
--- /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/absvsi2.c	2014-02-14 17:20:33.000000000 +0800
+++ builtins/absvsi2.c	2021-12-11 22:37:27.000000000 +0800
@@ -18,12 +18,31 @@
 
 /* Effects: aborts if abs(x) &lt; 0 */
 
+extern int printf(const char *format, ...);
 COMPILER_RT_ABI si_int
 __absvsi2(si_int a)
 {
+#if 0
     const int N = (int)(sizeof(si_int) * CHAR_BIT);
-    if (a == (1 &lt;&lt; (N-1)))
+    if (a == (1 &lt;&lt; (N-1))) {
         compilerrt_abort();
+    }
     const si_int t = a &gt;&gt; (N - 1);
     return (a ^ t) - t;
+#else
+  // Fix for Cpu0
+    si_int result;
+    const int N = (int)(sizeof(si_int) * CHAR_BIT);
+    if (a == (1 &lt;&lt; (N-1))) {
+    // In 2&#39;s compliment, positive only reach (power(2, N-1) - 1)
+        compilerrt_abort();
+    }
+    const si_int t = (1 &lt;&lt; (N-1));
+    if ((a &amp; t) == t)
+      // negative, t = 0x8000...0
+      result = 0 - a;
+    else
+      result = a;
+    return result;
+#endif
 }
diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/adddf3.c builtins/adddf3.c
--- /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/adddf3.c	2014-05-28 23:06:25.000000000 +0800
+++ builtins/adddf3.c	2021-12-11 22:37:27.000000000 +0800
@@ -13,6 +13,7 @@
 //===----------------------------------------------------------------------===//
 
 #define DOUBLE_PRECISION
+#undef __LP64__
 #include &quot;fp_add_impl.inc&quot;
 
 ARM_EABI_FNALIAS(dadd, adddf3)
Only in /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/: arm
Only in /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/: armv6m
Only in builtins/: cpu0-porting.c
diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/divdc3.c builtins/divdc3.c
--- /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/divdc3.c	2014-03-01 23:30:50.000000000 +0800
+++ builtins/divdc3.c	2021-12-11 22:37:27.000000000 +0800
@@ -21,7 +21,9 @@
 __divdc3(double __a, double __b, double __c, double __d)
 {
     int __ilogbw = 0;
-    double __logbw = crt_logb(crt_fmax(crt_fabs(__c), crt_fabs(__d)));
+// Cpu0 porting
+//    double __logbw = crt_logb(crt_fmax(crt_fabs(__c), crt_fabs(__d)));
+    double __logbw = crt_logb(fmax(crt_fabs(__c), crt_fabs(__d)));
     if (crt_isfinite(__logbw))
     {
         __ilogbw = (int)__logbw;
diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/fixdfsi.c builtins/fixdfsi.c
--- /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/fixdfsi.c	2014-03-01 23:30:50.000000000 +0800
+++ builtins/fixdfsi.c	2021-12-11 22:37:27.000000000 +0800
@@ -13,13 +13,18 @@
 //
 //===----------------------------------------------------------------------===//
 
+//#undef SINGLE_PRECISION
 #define DOUBLE_PRECISION
+//#define SINGLE_PRECISION
 #include &quot;fp_lib.h&quot;
 
 #include &quot;int_lib.h&quot;
 
 ARM_EABI_FNALIAS(d2iz, fixdfsi)
 
+int printf(const char *format, ...);
+int sprintf(char *out, const char *format, ...);
+
 COMPILER_RT_ABI int
 __fixdfsi(fp_t a) {
     
@@ -29,14 +34,29 @@
     const int sign = aRep &amp; signBit ? -1 : 1;
     const int exponent = (aAbs &gt;&gt; significandBits) - exponentBias;
     const rep_t significand = (aAbs &amp; significandMask) | implicitBit;
+#if 0
+    printf(&quot;__CONCAT(1, ULL)=%08x%08x, REP_C(1)=%08x%08x, implicitBit=%08x%08x\n&quot;, (int)(__CONCAT(1, ULL) &gt;&gt; 32), (int)(__CONCAT(1, ULL) &amp; 0xffffffff), (int)(REP_C(1) &gt;&gt; 32), (int)(REP_C(1) &amp; 0xffffffff), (int)(implicitBit &gt;&gt; 32), (int)(implicitBit &amp; 0xffffffff));
+    printf(&quot;significandBits=%x, ttt=%x, exponentBias=%x, signBit=%08x%08x\n&quot;, significandBits, ttt, exponentBias, (int)(signBit &gt;&gt; 32), (int)(signBit &amp; 0xffffffff));
+    printf(&quot;significandMask=%08x%08x\n&quot;, (int)(significandMask &gt;&gt; 32), (int)(significandMask &amp; 0xffffffff));
+    printf(&quot;sign=%x, exponent=%x, significand=%08x%08x\n&quot;, sign, exponent, (int)(significand &gt;&gt; 32), (int)(significand &amp; 0xffffffff));
+    printf(&quot;aAbs=%08x%08x, significandBits=%x\n&quot;, (int)(aAbs &gt;&gt; 32), (int)(aAbs &amp; 0xffffffff), significandBits);
+#endif
     
     // If 0 &lt; exponent &lt; significandBits, right shift to get the result.
     if ((unsigned int)exponent &lt; significandBits) {
         return sign * (significand &gt;&gt; (significandBits - exponent));
+#if 0
+        int aa = (int)(significandBits - exponent);
+        int bb = (int)(significand &gt;&gt; aa);
+        int cc = (int)(sign * bb);
+        printf(&quot;sign=%08x, significand=%08x%08x, aa=%08x, bb=%08x, cc=%08x\n&quot;, sign, (int)(significand &gt;&gt; 32), (int)(significand &amp; 0xffffffff), aa, bb, cc);
+        return cc;
+#endif
     }
     
     // If exponent is negative, the result is zero.
     else if (exponent &lt; 0) {
+        printf(&quot;2\n&quot;);
         return 0;
     }
     
@@ -45,6 +65,7 @@
     // behavior, but the conversion itself is undefined in that case, so
     // whatever the compiler decides to do is fine.
     else {
+        printf(&quot;3\n&quot;);
         return sign * (significand &lt;&lt; (exponent - significandBits));
     }
 }
diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/fixsfsi.c builtins/fixsfsi.c
--- /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/fixsfsi.c	2014-02-14 17:20:33.000000000 +0800
+++ builtins/fixsfsi.c	2021-12-11 22:37:27.000000000 +0800
@@ -18,6 +18,9 @@
 
 ARM_EABI_FNALIAS(f2iz, fixsfsi)
 
+int printf(const char *format, ...);
+int sprintf(char *out, const char *format, ...);
+
 COMPILER_RT_ABI int
 __fixsfsi(fp_t a) {
     // Break a into sign, exponent, significand
@@ -26,14 +29,28 @@
     const int sign = aRep &amp; signBit ? -1 : 1;
     const int exponent = (aAbs &gt;&gt; significandBits) - exponentBias;
     const rep_t significand = (aAbs &amp; significandMask) | implicitBit;
-    
+#if 0
+    printf(&quot;significandBits=%x, ttt=%x, exponentBias=%x, signBit=%x\n&quot;, significandBits, ttt, exponentBias, (int)signBit);
+    printf(&quot;REP_C(1)=%x, implicitBit=%x\n&quot;, REP_C(1), implicitBit);
+    printf(&quot;sign=%x, exponent=%x, significand=%x\n&quot;, sign, exponent, significand);
+    printf(&quot;aAbs=%x, significandMask=%x, implicitBit=%x, significandBits=%x, ttt=%x\n&quot;, aAbs, significandMask, implicitBit, significandBits, ttt);
+#endif
+
     // If 0 &lt; exponent &lt; significandBits, right shift to get the result.
     if ((unsigned int)exponent &lt; significandBits) {
         return sign * (significand &gt;&gt; (significandBits - exponent));
+#if 0
+        int aa = (int)(significandBits - exponent);
+        int bb = (int)(significand &gt;&gt; aa);
+        int cc = (int)(sign * bb);
+        printf(&quot;sign=%08x, significand=%08x, aa=%08x, bb=%08x, cc=%08x\n&quot;, sign, (int)(significand &amp; 0xffffffff), aa, bb, cc);
+        return cc;
+#endif
     }
     
     // If exponent is negative, the result is zero.
     else if (exponent &lt; 0) {
+        printf(&quot;2\n&quot;);
         return 0;
     }
     
@@ -42,6 +59,7 @@
     // behavior, but the conversion itself is undefined in that case, so
     // whatever the compiler decides to do is fine.
     else {
+        printf(&quot;3\n&quot;);
         return sign * (significand &lt;&lt; (exponent - significandBits));
     }
 }
diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/floatundidf.c builtins/floatundidf.c
--- /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/floatundidf.c	2014-03-01 23:30:50.000000000 +0800
+++ builtins/floatundidf.c	2021-12-11 22:37:27.000000000 +0800
@@ -21,15 +21,15 @@
 /* seee eeee eeee mmmm mmmm mmmm mmmm mmmm | mmmm mmmm mmmm mmmm mmmm mmmm mmmm mmmm */
 
 #include &quot;int_lib.h&quot;
-
-ARM_EABI_FNALIAS(ul2d, floatundidf)
+#if 1
+//ARM_EABI_FNALIAS(ul2d, floatundidf)
 
 #ifndef __SOFT_FP__
 /* Support for systems that have hardware floating-point; we&#39;ll set the inexact flag
  * as a side-effect of this computation.
  */
 
-COMPILER_RT_ABI double
+/*COMPILER_RT_ABI */double
 __floatundidf(du_int a)
 {
 	static const double twop52 = 0x1.0p52;
@@ -51,7 +51,7 @@
  * set, and we don&#39;t want to code-gen to an unknown soft-float implementation.
  */ 
 
-COMPILER_RT_ABI double
+/*COMPILER_RT_ABI */double
 __floatundidf(du_int a)
 {
     if (a == 0)
@@ -98,9 +98,11 @@
         /* a is now rounded to DBL_MANT_DIG bits */
     }
     double_bits fb;
-    fb.u.high = ((e + 1023) &lt;&lt; 20)      |        /* exponent */
+    fb.u.s.high = ((e + 1023) &lt;&lt; 20)      |        /* exponent */
                 ((su_int)(a &gt;&gt; 32) &amp; 0x000FFFFF); /* mantissa-high */
-    fb.u.low = (su_int)a;                         /* mantissa-low  */
+    fb.u.s.low = (su_int)a;                         /* mantissa-low  */
     return fb.f;
 }
 #endif
+
+#endif
diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/fp_lib.h builtins/fp_lib.h
--- /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/fp_lib.h	2014-07-08 16:52:57.000000000 +0800
+++ builtins/fp_lib.h	2021-12-11 22:37:27.000000000 +0800
@@ -38,13 +38,15 @@
 # endif
 #endif
 
-#if defined SINGLE_PRECISION
+//#if defined SINGLE_PRECISION
+#if defined(SINGLE_PRECISION)
 
 typedef uint32_t rep_t;
 typedef int32_t srep_t;
 typedef float fp_t;
 #define REP_C UINT32_C
 #define significandBits 23
+#define ttt 1
 
 static inline int rep_clz(rep_t a) {
     return __builtin_clz(a);
@@ -58,13 +60,17 @@
 }
 COMPILER_RT_ABI fp_t __addsf3(fp_t a, fp_t b);
 
-#elif defined DOUBLE_PRECISION
+//#elif defined DOUBLE_PRECISION
+#elif defined(DOUBLE_PRECISION)
 
 typedef uint64_t rep_t;
 typedef int64_t srep_t;
 typedef double fp_t;
+//#define REP_C UINT64_C
+#undef REP_C
 #define REP_C UINT64_C
 #define significandBits 52
+#define ttt 2
 
 static inline int rep_clz(rep_t a) {
 #if defined __LP64__
@@ -101,7 +107,8 @@
 
 COMPILER_RT_ABI fp_t __adddf3(fp_t a, fp_t b);
 
-#elif defined QUAD_PRECISION
+//#elif defined QUAD_PRECISION
+#elif defined(QUAD_PRECISION)
 #if __LDBL_MANT_DIG__ == 113
 #define CRT_LDBL_128BIT
 typedef __uint128_t rep_t;
Only in /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/: i386
diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/int_lib.h builtins/int_lib.h
--- /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/int_lib.h	2014-05-13 00:47:01.000000000 +0800
+++ builtins/int_lib.h	2021-12-11 22:37:27.000000000 +0800
@@ -37,28 +37,15 @@
 # define COMPILER_RT_ABI COMPILER_RT_EXPORT
 #endif
 
-#if defined(__NetBSD__) &amp;&amp; (defined(_KERNEL) || defined(_STANDALONE))
-/*
- * Kernel and boot environment can&#39;t use normal headers,
- * so use the equivalent system headers.
- */
-#  include &lt;machine/limits.h&gt;
-#  include &lt;sys/stdint.h&gt;
-#  include &lt;sys/types.h&gt;
-#else
-/* Include the standard compiler builtin headers we use functionality from. */
-#  include &lt;limits.h&gt;
-#  include &lt;stdint.h&gt;
-#  include &lt;stdbool.h&gt;
-#  include &lt;float.h&gt;
-#endif
-
 /* Include the commonly used internal type definitions. */
 #include &quot;int_types.h&quot;
 
 /* Include internal utility function declarations. */
 #include &quot;int_util.h&quot;
 
+/* Include the standard compiler builtin headers we use functionality from. */
+#  include &lt;limits.h&gt;
+
 COMPILER_RT_ABI si_int __paritysi2(si_int a);
 COMPILER_RT_ABI si_int __paritydi2(di_int a);
 
@@ -73,4 +60,6 @@
 COMPILER_RT_ABI tu_int __udivmodti4(tu_int a, tu_int b, tu_int* rem);
 #endif
 
+#define __SOFT_FP__ 1
+
 #endif /* INT_LIB_H */
diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/int_math.h builtins/int_math.h
--- /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/int_math.h	2014-02-14 17:20:33.000000000 +0800
+++ builtins/int_math.h	2021-12-11 22:37:27.000000000 +0800
@@ -47,11 +47,11 @@
 #define crt_copysign(x, y) __builtin_copysign((x), (y))
 #define crt_copysignf(x, y) __builtin_copysignf((x), (y))
 #define crt_copysignl(x, y) __builtin_copysignl((x), (y))
-
+/*
 #define crt_fabs(x) __builtin_fabs((x))
 #define crt_fabsf(x) __builtin_fabsf((x))
 #define crt_fabsl(x) __builtin_fabsl((x))
-
+*/
 #define crt_fmax(x, y) __builtin_fmax((x), (y))
 #define crt_fmaxf(x, y) __builtin_fmaxf((x), (y))
 #define crt_fmaxl(x, y) __builtin_fmaxl((x), (y))
diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/int_types.h builtins/int_types.h
--- /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/int_types.h	2014-05-19 23:48:46.000000000 +0800
+++ builtins/int_types.h	2021-12-11 22:37:27.000000000 +0800
@@ -18,7 +18,9 @@
 #ifndef INT_TYPES_H
 #define INT_TYPES_H
 
-#include &quot;int_endianness.h&quot;
+//#include &quot;int_endianness.h&quot;
+#define _YUGA_LITTLE_ENDIAN 0
+#define _YUGA_BIG_ENDIAN    1
 
 typedef      int si_int;
 typedef unsigned su_int;
@@ -139,5 +141,14 @@
     long double f;
 } long_double_bits;
 
+#include &lt;stdbool.h&gt;
+//#define bool int
+//typedef unsigned char	uint8_t;
+#define uint32_t unsigned int
+#define uint64_t unsigned long long
+//typedef unsigned int	uintptr_t;
+#define FLT_MANT_DIG 24
+#define DBL_MANT_DIG 53
+
 #endif /* INT_TYPES_H */
 
diff -u -r /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/int_util.c builtins/int_util.c
--- /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/int_util.c	2014-02-14 17:20:33.000000000 +0800
+++ builtins/int_util.c	2021-12-11 22:37:27.000000000 +0800
@@ -58,4 +58,8 @@
   abort();
 }
 
+void abort() {
+  return;
+}
+
 #endif
Only in builtins/: libFloat.o
Only in /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/: ppc
Only in /Users/chungshu/Documents/compiler-rt-3.5.0.src/lib/builtins/: x86_64
</pre></div>
</div>
<p class="rubric">lbt/exlbt/libsoftfloat/compiler-rt/builtins/Makefile</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CC=clang
LLC=~/llvm/test/cmake_debug_build/bin/llc
LINK=~/llvm/test/cmake_debug_build/bin/lld
INCFLAG=-I/home/cschen/test/open-src-libc/avr-libc-1.8.1/include -I/home/cschen/test/open-src-libc/avr-libc-1.8.1/common
CFLAGS=-target mips-unknown-linux-gnu -emit-llvm ${INCFLAG} -S
LLCFLAGS=-march=cpu0 -relocation-model=static -filetype=obj
LDFLAGS=-flavor gnu -target cpu0-unknown-linux-gnu 
#SOURCES := absvdi2.c absvsi2.c absvti2.c adddf3.c addsf3.c addtf3.c addvdi3.c \
#  addvsi3.c addvti3.c apple_versioning.c ashldi3.c ashlti3.c ashrdi3.c \
#  ashrti3.c clear_cache.c clzdi2.c clzsi2.c clzti2.c cmpdi2.c cmpti2.c \
#  comparedf2.c comparesf2.c ctzdi2.c ctzsi2.c ctzti2.c divdc3.c divdf3.c \
#  divdi3.c divmoddi4.c divmodsi4.c divsc3.c divsf3.c divsi3.c divti3.c divtf3.c \
#  divxc3.c

SOURCES := absvdi2.c absvsi2.c absvti2.c 

OUTPUT_OBJ_DIR=obj
#$(sources:.c=.d)
#IRS := $(addprefix , $(addsuffix .o, ${SOURCES}))
IRS := $(SOURCES:.c=.l)
#IRS=$(SOURCES:.c=.ll)
OBJECTS=$(IRS:.l=.o)
EXECUTABLE=compiler-rt.bc

all: $(SOURCES) $(EXECUTABLE)
	
$(EXECUTABLE): $(OBJECTS)
	${LINK} ${LDFLAGS} ${OBJECTS} -o $@

$(OBJECTS): %.o: %.ll
	${LLC} ${LLCFLAGS} $&lt; -o $@

$(IRS): $(SOURCES)
	${CC} ${CFLAGS} $&lt; -o $@

.PHONY: clean
clean:
	rm -rf ${OUTPUT_OBJ_DIR} *.bc *.ll *.o

</pre></div>
</div>
<p class="rubric">lbt/exlbt/libsoftfloat/compiler-rt/builtins/cpu0-porting.c</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/*
float __TGMATH_BINARY_REAL_ONLY(Val1, Val2, Fct)
{
  return  (__extension__ (((sizeof (Val1) &gt; sizeof (double)
		       || sizeof (Val2) &gt; sizeof (double))
		      &amp;&amp; __builtin_classify_type ((Val1) + (Val2)) == 8)
		     ? (__typeof ((__tgmath_real_type (Val1)) 0
				   + (__tgmath_real_type (Val2)) 0))
		       __tgml(Fct) (Val1, Val2)
		     : (sizeof (Val1) == sizeof (double)
			|| sizeof (Val2) == sizeof (double)
			|| __builtin_classify_type (Val1) != 8
			|| __builtin_classify_type (Val2) != 8)
		     ? (__typeof ((__tgmath_real_type (Val1)) 0	
				   + (__tgmath_real_type (Val2)) 0))
		       Fct (Val1, Val2)
		     : (__typeof ((__tgmath_real_type (Val1)) 0
				   + (__tgmath_real_type (Val2)) 0))
		       Fct##f (Val1, Val2)));
}
*/

#define FS_SIGNED_M       0x80000000
#define FS_EXP_M          0x7f800000
#define FS_SIGNIFICAND_M  0x007fffff

float fmax(float x, float y)
{
  int x_b31 = ((unsigned int)x &amp; FS_SIGNED_M) &gt;&gt; 31;
  int x_exp_signi = ((unsigned int)x &amp; (FS_EXP_M | FS_SIGNIFICAND_M));
  int y_b31 = ((unsigned int)y &amp; FS_SIGNED_M) &gt;&gt; 31;
  int y_exp_signi = ((unsigned int)y &amp; (FS_EXP_M | FS_SIGNIFICAND_M));
  if (x_b31 == 1 &amp;&amp; y_b31 == 1) {
    if (x_exp_signi &gt; y_exp_signi) {
      return y;
    }
    else {
      return x;
    }
  }
  else if (x_b31 == 0 &amp;&amp; y_b31 == 1) {
    return x;
  }
  else if (x_b31 == 1 &amp;&amp; y_b31 == 0) {
    return y;
  }
  else if (x_b31 == 0 &amp;&amp; y_b31 == 0) {
    if (x_exp_signi &gt;= y_exp_signi) {
      return x;
    }
    else {
      return y;
    }
  }
}

float fabsf(float x)
{
  float* p = &amp;x;
  int x_b31 = ((unsigned int)(*p) &amp; FS_SIGNED_M) &gt;&gt; 31;
  if (x_b31 == 1) {
    x = (float)((unsigned int)(*p) | FS_SIGNED_M);
    return (float)(*p);
  }
  else
    return (float)(*p);
}

#define DS_SIGNED_M       0x8000000000000000

double fabsl(double x)
{
  double* p = &amp;x;
  int x_b31 = ((unsigned long long)(*p) &amp; DS_SIGNED_M) &gt;&gt; 63;
  if (x_b31 == 1) {
    x = (double)((unsigned long long)(*p) | FS_SIGNED_M);
    return (double)(*p);
  }
  else
    return (float)(*p);
}

float fabs(float x)
{
  return fabsf(x);
}
</pre></div>
</div>
<p class="rubric">lbt/exlbt/libsoftfloat/compiler-rt/Makefile</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Thanks .c .cb Vranish (https://spin.a.cmi.cbject..cm/2016/08/26/makefile-c-p.cjects/)

# CPU and endian passed from command line, such as &quot;make CPU=cpu032II endian=&quot;
#CPU := cpu032II
#endian :=

TARGET_LIB := libFloat.a
BUILD_DIR := ./build
TARGET := $(BUILD_DIR)/$(TARGET_LIB)
SRC_DIR := ./builtins

TOOLDIR := ~/llvm/test/build/bin
CC := $(TOOLDIR)/clang
AR := $(TOOLDIR)/llvm-ar

SRCS := absvdi2.c absvsi2.c absvti2.c adddf3.c addsf3.c addtf3.c addvdi3.c \
  addvsi3.c addvti3.c ashldi3.c ashlti3.c ashrdi3.c \
  ashrti3.c clear_cache.c clzdi2.c clzsi2.c clzti2.c cmpdi2.c cmpti2.c \
  comparedf2.c comparesf2.c ctzdi2.c ctzsi2.c ctzti2.c divdf3.c \
  divdi3.c divmoddi4.c divmodsi4.c divsf3.c divsi3.c divti3.c divtf3.c \
  extendsfdf2.c ffsdi2.c ffsti2.c \
  fixdfdi.c fixdfsi.c fixdfti.c fixsfdi.c fixsfsi.c fixsfti.c fixunsdfdi.c \
  fixunsdfsi.c fixunsdfti.c fixunssfdi.c fixunssfsi.c fixunssfti.c \
  fixunsxfdi.c fixunsxfsi.c fixunsxfti.c fixxfdi.c fixxfti.c floatundidf.c \
  floatdisf.c floatdixf.c floatsidf.c floatsisf.c floattidf.c floattisf.c \
  floattixf.c floatundisf.c floatundixf.c floatunsidf.c \
  floatunsisf.c floatuntidf.c floatuntisf.c floatuntixf.c \
  int_util.c lshrdi3.c lshrti3.c moddi3.c \
  modsi3.c modti3.c muldc3.c muldf3.c muldi3.c mulodi4.c mulosi4.c \
  muloti4.c mulsc3.c mulsf3.c multi3.c multf3.c mulvdi3.c mulvsi3.c \
  mulvti3.c mulxc3.c negdf2.c negdi2.c negsf2.c negti2.c negvdi2.c \
  negvsi2.c negvti2.c paritydi2.c paritysi2.c parityti2.c \
  popcountdi2.c popcountsi2.c popcountti2.c powidf2.c \
  powisf2.c powitf2.c powixf2.c subdf3.c subsf3.c subvdi3.c \
  subvsi3.c subvti3.c subtf3.c trampoline_setup.c truncdfsf2.c \
  ucmpdi2.c ucmpti2.c udivdi3.c udivmoddi4.c udivmodsi4.c udivmodti4.c \
  udivsi3.c udivti3.c umoddi3.c umodsi3.c umodti3.c cpu0-porting.c

# String substitution for every C file.
# As an example, absvdi2.c turns into ./builtins/hello.c
SRCS := $(SRCS:%=$(SRC_DIR)/%)

# String substitution for every C/C++ file.
# As an example, hello.cpp turns into ./build/hello.cpp.o
OBJS := $(SRCS:%=$(BUILD_DIR)/%.o)

# String substitut.cn (suffix version without %).
# As an example, ./build/helloc.cpp.c turns in.c ./build/helloc.cpp.d
DEPS := $(OBJS:.o=.d)

# Every folder in ./src will need to be passed to GCC so that it can find header files
INC_DIRS := $(shell find $(SRC_DIR) -type d) ../../libc/avr-libc-1.8.1/include
# Add a prefix to INC_DIRS. So moduleA would become -ImoduleA. GCC understands this -I flag
INC_FLAGS := $(addprefix -I,$(INC_DIRS))

# The -MMD and -MP flags together generate Makefiles for us!
# These files will have .d instead of .o as the output.
CPPFLAGS := -MMD -MP -target cpu0${endian}-unknown-linux-gnu -static \
  -fintegrated-as ${INC_FLAGS} -mcpu=${CPU} -mllvm -has-lld=true

# The final build step.
$(TARGET): $(OBJS)
	$(AR) -rcs $@ $(OBJS)

# Build step for C source
$(BUILD_DIR)/%.c.o: %.c
	mkdir -p $(dir $@)
	$(CC) $(CPPFLAGS) $(CFLAGS) -c $&lt; -o $@


.PHONY: clean
clean:
	rm -rf $(BUILD_DIR)

# Include the .d makefiles. The - at the f.cnt suppresses the er.crs.cf missing
# Makefiles. Initially, all the .d files will be missing, and we .cn&#39;t want t.cse
# er.crs .c s.cw up.
-include $(DEPS)
</pre></div>
</div>
</section>
<section id="avr-libc">
<h2><a class="toc-backref" href="#id9">Avr libc</a><a class="headerlink" href="#avr-libc" title="Permalink to this headline">¶</a></h2>
<p>Directory libex/libc/avr-libc-1.8.1 include the libc porting.</p>
<p>AVR Libc is a Free Software project whose goal is to provide a high quality C
library for use with GCC on Atmel AVR microcontrollers. AVR Libc is licensed
under a single unified license. This so-called modified Berkeley license is
intented to be compatible with most Free Software licenses like the GPL, yet
impose as little restrictions for the use of the library in closed-source
commercial applications as possible <a class="footnote-reference brackets" href="#avr-libc-license" id="id2">2</a>.</p>
<p>The source code can be download from here <a class="footnote-reference brackets" href="#avr-libc-download" id="id3">3</a>.
Document are here <a class="footnote-reference brackets" href="#avr-libc-doc-web" id="id4">4</a> <a class="footnote-reference brackets" href="#avr-libc-doc-pdf" id="id5">5</a>.</p>
</section>
<section id="software-float-point-support">
<h2><a class="toc-backref" href="#id10">Software Float Point Support</a><a class="headerlink" href="#software-float-point-support" title="Permalink to this headline">¶</a></h2>
<p class="rubric">exlbt/input/ch_float_necessary.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//#include &quot;debug.h&quot;

extern &quot;C&quot; int printf(const char *format, ...);
extern &quot;C&quot; int sprintf(char *out, const char *format, ...);

template &lt;class T&gt;
T test_shift_left(T a, T b) {
  return (a &lt;&lt; b);
}

template &lt;class T&gt;
T test_shift_right(T a, T b) {
  return (a &gt;&gt; b);
}

template &lt;class T1, class T2, class T3&gt;
T1 test_add(T2 a, T3 b) {
  T1 c = a + b;
  return c;
}

template &lt;class T1, class T2, class T3&gt;
T1 test_mul(T2 a, T3 b) {
  T1 c = a * b;
  return c;
}

template &lt;class T1, class T2, class T3&gt;
T1 test_div(T2 a, T3 b) {
  T1 c = a / b;
  return c;
}

int main() {
  int a;

// call __ashldi3
  a = (int)test_shift_left&lt;long long&gt;(0x12, 4); // 0x120 = 288
  printf(&quot;(int)test_shift_left&lt;long long&gt;(0x12, 4) = %d\n&quot;, a);
  
// call __ashrdi3
  a = (int)test_shift_right&lt;long long&gt;(0x001666660000000a, 48); // 0x16 = 22
  printf(&quot;(int)test_shift_right&lt;long long&gt;(0x001666660000000a, 48) = %d\n&quot;, a);
  
// call __lshrdi3
  a = (int)test_shift_right&lt;unsigned long long&gt;(0x001666660000000a, 48); // 0x16 = 22
  printf(&quot;(int)test_shift_right&lt;unsigned long long&gt;(0x001666660000000a, 48) = %d\n&quot;, a);
  
// call __addsf3, __fixsfsi
  a = (int)test_add&lt;float, float, float&gt;(-2.2, 3.3); // (int)1.1 = 1
  printf(&quot;(int)test_add&lt;float, float, float&gt;(-2.2, 3.3) = %d\n&quot;, a);
  
// call __mulsf3, __fixsfsi
  a = (int)test_mul&lt;float, float, float&gt;(-2.2, 3.3); // (int)-7.26 = -7
  printf(&quot;(int)test_mul&lt;float, float, float&gt;(-2.2, 3.3) = %d\n&quot;, a);
  
// call __divsf3, __fixsfsi
  a = (int)test_div&lt;float, float, float&gt;(-1.8, 0.5); // (int)-3.6 = -3
  printf(&quot;(int)test_div&lt;float, float, float&gt;(-1.8, 0.5) = %d\n&quot;, a);
  
// call __extendsfdf2, __adddf3, __fixdfsi
  a = (int)test_add&lt;double, double, float&gt;(-2.2, 3.3); // (int)1.1 = 1
  printf(&quot;(int)test_add&lt;double, double, float&gt;(-2.2, 3.3) = %d\n&quot;, a);
  
// call __extendsfdf2, __muldf3, __fixdfsi
  a = (int)test_mul&lt;double, float, double&gt;(-2.2, 3.3); // (int)-7.26 = -7
  printf(&quot;(int)test_mul&lt;double, float, double&gt;(-2.2, 3.3) = %d\n&quot;, a);
  
// call __extendsfdf2, __muldf3, __truncdfsf2, __fixdfsi
// ! __truncdfsf2 in truncdfsf2.c is not work for Cpu0
  a = (int)test_mul&lt;float, float, double&gt;(-2.2, 3.3); // (int)-7.26 = -7
  printf(&quot;(int)test_mul&lt;float, float, double&gt;(-2.2, 3.3) = %d\n&quot;, a);
  
// call __divdf3, __fixdfsi
  a = (int)test_div&lt;double, double, double&gt;(-1.8, 0.5); // (int)-3.6 = -3
  printf(&quot;(int)test_div&lt;double, double, double&gt;(-1.8, 0.5) = %d\n&quot;, a);
  
  return 0;
}

</pre></div>
</div>
<p class="rubric">exlbt/input/Makefile.float-necessary</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># CPU and endian passed from command line, such as 
#   &quot;make -f Makefile.float-necessary CPU=cpu032II endian=&quot;
#   Ignore argument and set CPU to cpu032II since software float point library, 
#   libsoftfloat, only supports cpu032II at this point.
CPU := cpu032II
#endian :=

SRCS := start.cpp debug.cpp printf-stdarg-def.c printf-stdarg.c ch_float_necessary.cpp lib_cpu0.ll
INC_DIRS := $(SRC_DIR)
LIB_DIR := ../libsoftfloat/compiler-rt
LIBS := $(LIB_DIR)/build/libFloat.a

include Common.mk
</pre></div>
</div>
<p>Run as follows,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">chungshu@ChungShudeMacBook-Air input % </span>bash make.sh cpu032II be Makefile.float-necessary
<span class="go">...</span>
<span class="go">endian =  BigEndian</span>
<span class="go">ISR address:00020614</span>
<span class="go">0   /* 0: big endian, 1: little endian */</span>

<span class="gp">chungshu@ChungShudeMacBook-Air verilog % </span>iverilog -o cpu0IIs cpu0IIs.v
<span class="gp">chungshu@ChungShudeMacBook-Air verilog % </span>./cpu0IIs
<span class="go">ARNING: cpu0.v:487: $readmemh(cpu0.hex): Not enough words in the file for the requested range [0:524287].</span>
<span class="go">taskInterrupt(001)</span>
<span class="gp gp-VirtualEnv">(int)</span><span class="go">test_shift_left&lt;long long&gt;(0x12, 4) = 288</span>
<span class="gp gp-VirtualEnv">(int)</span><span class="go">test_shift_right&lt;long long&gt;(0x001666660000000a, 48) = 22</span>
<span class="gp gp-VirtualEnv">(int)</span><span class="go">test_shift_right&lt;unsigned long long&gt;(0x001666660000000a, 48) = 22</span>
<span class="gp gp-VirtualEnv">(int)</span><span class="go">test_add&lt;float, float, float&gt;(-2.2, 3.3) = 1</span>
<span class="gp gp-VirtualEnv">(int)</span><span class="go">test_mul&lt;float, float, float&gt;(-2.2, 3.3) = -7</span>
<span class="gp gp-VirtualEnv">(int)</span><span class="go">test_div&lt;float, float, float&gt;(-1.8, 0.5) = -3</span>
<span class="gp gp-VirtualEnv">(int)</span><span class="go">test_add&lt;double, double, float&gt;(-2.2, 3.3) = 1</span>
<span class="gp gp-VirtualEnv">(int)</span><span class="go">test_mul&lt;float, float, double&gt;(-2.2, 3.3) = -7</span>
<span class="gp gp-VirtualEnv">(int)</span><span class="go">test_mul&lt;float, float, double&gt;(-2.2, 3.3) = 0</span>
<span class="gp gp-VirtualEnv">(int)</span><span class="go">test_div&lt;double, double, double&gt;(-1.8, 0.5) = -3</span>
<span class="go">total cpu cycles = 184085</span>
<span class="go">RET to PC &lt; 0, finished!</span>
</pre></div>
</div>
<dl class="footnote brackets">
<dt class="label" id="id6"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p><a class="reference external" href="http://compiler-rt.llvm.org/">http://compiler-rt.llvm.org/</a></p>
</dd>
<dt class="label" id="avr-libc-license"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p><a class="reference external" href="http://www.nongnu.org/avr-libc/">http://www.nongnu.org/avr-libc/</a></p>
</dd>
<dt class="label" id="avr-libc-download"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p><a class="reference external" href="http://download.savannah.gnu.org/releases/avr-libc/">http://download.savannah.gnu.org/releases/avr-libc/</a></p>
</dd>
<dt class="label" id="avr-libc-doc-web"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p><a class="reference external" href="http://www.atmel.com/webdoc/AVRLibcReferenceManual/index.html">http://www.atmel.com/webdoc/AVRLibcReferenceManual/index.html</a></p>
</dd>
<dt class="label" id="avr-libc-doc-pdf"><span class="brackets"><a class="fn-backref" href="#id5">5</a></span></dt>
<dd><p><a class="reference external" href="http://courses.cs.washington.edu/courses/csep567/04sp/pdfs/avr-libc-user-manual.pdf">http://courses.cs.washington.edu/courses/csep567/04sp/pdfs/avr-libc-user-manual.pdf</a></p>
</dd>
</dl>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="opt.html">Optimization</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Chen Chung-Shu.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.1.
    </div>
  </body>
</html>