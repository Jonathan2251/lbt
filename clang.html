
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Clang &#8212; Tutorial: Creating an LLVM Toolchain for the Cpu0 Architecture</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/haiku.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Library" href="lib.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Toolchain for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Clang</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="lib.html">Library</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="clang">
<span id="sec-clang"></span><h1>Clang<a class="headerlink" href="#clang" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#cpu0-target" id="id1">Cpu0 target</a></p></li>
<li><p><a class="reference internal" href="#verify" id="id2">Verify</a></p></li>
</ul>
</div>
<p>This chapter add Cpu0 target to frontend clang.</p>
<section id="cpu0-target">
<h2><a class="toc-backref" href="#id1">Cpu0 target</a><a class="headerlink" href="#cpu0-target" title="Permalink to this headline">¶</a></h2>
<p class="rubric">exlbt/clang/include/clang/Basic/TargetBuiltins.h</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">  /// CPU0 builtins</span>
<span class="go">  namespace Cpu0 {</span>
<span class="go">    enum {</span>
<span class="go">        LastTIBuiltin = clang::Builtin::FirstTSBuiltin-1,</span>
<span class="gp">#</span>define BUILTIN<span class="o">(</span>ID, TYPE, ATTRS<span class="o">)</span> BI##ID,
<span class="gp">#</span>include <span class="s2">&quot;clang/Basic/BuiltinsCpu0.def&quot;</span>
<span class="go">        LastTSBuiltin</span>
<span class="go">    };</span>
<span class="go">  }</span>
</pre></div>
</div>
<p class="rubric">exlbt/clang/include/clang/Basic/BuiltinsCpu0.def</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">BuiltinsCpu0</span><span class="o">.</span><span class="k">def</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Builtin</span> <span class="n">function</span> <span class="n">database</span> <span class="o">--------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-==//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">LLVM</span> <span class="n">Project</span><span class="p">,</span> <span class="n">under</span> <span class="n">the</span> <span class="n">Apache</span> <span class="n">License</span> <span class="n">v2</span><span class="mf">.0</span> <span class="k">with</span> <span class="n">LLVM</span> <span class="n">Exceptions</span><span class="o">.</span>
<span class="o">//</span> <span class="n">See</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">llvm</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">LICENSE</span><span class="o">.</span><span class="n">txt</span> <span class="k">for</span> <span class="n">license</span> <span class="n">information</span><span class="o">.</span>
<span class="o">//</span> <span class="n">SPDX</span><span class="o">-</span><span class="n">License</span><span class="o">-</span><span class="n">Identifier</span><span class="p">:</span> <span class="n">Apache</span><span class="o">-</span><span class="mf">2.0</span> <span class="n">WITH</span> <span class="n">LLVM</span><span class="o">-</span><span class="n">exception</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">defines</span> <span class="n">the</span> <span class="n">CPU0</span><span class="o">-</span><span class="n">specific</span> <span class="n">builtin</span> <span class="n">function</span> <span class="n">database</span><span class="o">.</span> <span class="n">Users</span> <span class="n">of</span>
<span class="o">//</span> <span class="n">this</span> <span class="n">file</span> <span class="n">must</span> <span class="n">define</span> <span class="n">the</span> <span class="n">BUILTIN</span> <span class="n">macro</span> <span class="n">to</span> <span class="n">make</span> <span class="n">use</span> <span class="n">of</span> <span class="n">this</span> <span class="n">information</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//</span> <span class="n">The</span> <span class="nb">format</span> <span class="n">of</span> <span class="n">this</span> <span class="n">database</span> <span class="n">matches</span> <span class="n">clang</span><span class="o">/</span><span class="n">Basic</span><span class="o">/</span><span class="n">Builtins</span><span class="o">.</span><span class="n">def</span><span class="o">.</span>

<span class="n">BUILTIN</span><span class="p">(</span><span class="n">__builtin_cpu0_gcd</span><span class="p">,</span> <span class="s2">&quot;iii&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">)</span>

<span class="c1">#undef BUILTIN</span>
</pre></div>
</div>
<p class="rubric">exlbt/clang/include/clang/lib/Driver/CMakeLists.txt</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ToolChains/Arch/Cpu0.cpp</span>
</pre></div>
</div>
<p class="rubric">exlbt/clang/lib/Driver/ToolChains/CommonArgs.cpp</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span>include <span class="s2">&quot;Arch/Cpu0.h&quot;</span>
<span class="go">...</span>
<span class="go">  case llvm::Triple::cpu0:</span>
<span class="go">  case llvm::Triple::cpu0el: {</span>
<span class="go">    StringRef CPUName;</span>
<span class="go">    StringRef ABIName;</span>
<span class="go">    cpu0::getCpu0CPUAndABI(Args, T, CPUName, ABIName);</span>
<span class="go">    return std::string(CPUName);</span>
<span class="go">  }</span>
</pre></div>
</div>
<p class="rubric">exlbt/clang/lib/Driver/ToolChains/Arch/Cpu0.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===---</span> <span class="n">Cpu0</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu0</span><span class="o">-</span><span class="n">specific</span> <span class="n">Tool</span> <span class="n">Helpers</span> <span class="o">----------------------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">LLVM</span> <span class="n">Project</span><span class="p">,</span> <span class="n">under</span> <span class="n">the</span> <span class="n">Apache</span> <span class="n">License</span> <span class="n">v2</span><span class="mf">.0</span> <span class="k">with</span> <span class="n">LLVM</span> <span class="n">Exceptions</span><span class="o">.</span>
<span class="o">//</span> <span class="n">See</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">llvm</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">LICENSE</span><span class="o">.</span><span class="n">txt</span> <span class="k">for</span> <span class="n">license</span> <span class="n">information</span><span class="o">.</span>
<span class="o">//</span> <span class="n">SPDX</span><span class="o">-</span><span class="n">License</span><span class="o">-</span><span class="n">Identifier</span><span class="p">:</span> <span class="n">Apache</span><span class="o">-</span><span class="mf">2.0</span> <span class="n">WITH</span> <span class="n">LLVM</span><span class="o">-</span><span class="n">exception</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_CLANG_LIB_DRIVER_TOOLCHAINS_ARCH_CPU0_H</span>
<span class="c1">#define LLVM_CLANG_LIB_DRIVER_TOOLCHAINS_ARCH_CPU0_H</span>

<span class="c1">#include &quot;clang/Driver/Driver.h&quot;</span>
<span class="c1">#include &quot;llvm/ADT/StringRef.h&quot;</span>
<span class="c1">#include &quot;llvm/ADT/Triple.h&quot;</span>
<span class="c1">#include &quot;llvm/Option/Option.h&quot;</span>
<span class="c1">#include &lt;string&gt;</span>
<span class="c1">#include &lt;vector&gt;</span>

<span class="n">namespace</span> <span class="n">clang</span> <span class="p">{</span>
<span class="n">namespace</span> <span class="n">driver</span> <span class="p">{</span>
<span class="n">namespace</span> <span class="n">tools</span> <span class="p">{</span>

<span class="n">namespace</span> <span class="n">cpu0</span> <span class="p">{</span>

<span class="n">void</span> <span class="n">getCpu0CPUAndABI</span><span class="p">(</span><span class="n">const</span> <span class="n">llvm</span><span class="p">::</span><span class="n">opt</span><span class="p">::</span><span class="n">ArgList</span> <span class="o">&amp;</span><span class="n">Args</span><span class="p">,</span>
                      <span class="n">const</span> <span class="n">llvm</span><span class="p">::</span><span class="n">Triple</span> <span class="o">&amp;</span><span class="n">Triple</span><span class="p">,</span> <span class="n">StringRef</span> <span class="o">&amp;</span><span class="n">CPUName</span><span class="p">,</span>
                      <span class="n">StringRef</span> <span class="o">&amp;</span><span class="n">ABIName</span><span class="p">);</span>

<span class="p">}</span> <span class="o">//</span> <span class="n">end</span> <span class="n">namespace</span> <span class="n">cpu0</span>
<span class="p">}</span> <span class="o">//</span> <span class="n">end</span> <span class="n">namespace</span> <span class="n">target</span>
<span class="p">}</span> <span class="o">//</span> <span class="n">end</span> <span class="n">namespace</span> <span class="n">driver</span>
<span class="p">}</span> <span class="o">//</span> <span class="n">end</span> <span class="n">namespace</span> <span class="n">clang</span>

<span class="c1">#endif // LLVM_CLANG_LIB_DRIVER_TOOLCHAINS_ARCH_CPU0_H</span>
</pre></div>
</div>
<p class="rubric">exlbt/clang/lib/Driver/ToolChains/Arch/Cpu0.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//===---</span> <span class="n">Cpu0</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Tools</span> <span class="n">Implementations</span> <span class="o">-----------------------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">LLVM</span> <span class="n">Project</span><span class="p">,</span> <span class="n">under</span> <span class="n">the</span> <span class="n">Apache</span> <span class="n">License</span> <span class="n">v2</span><span class="mf">.0</span> <span class="k">with</span> <span class="n">LLVM</span> <span class="n">Exceptions</span><span class="o">.</span>
<span class="o">//</span> <span class="n">See</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">llvm</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">LICENSE</span><span class="o">.</span><span class="n">txt</span> <span class="k">for</span> <span class="n">license</span> <span class="n">information</span><span class="o">.</span>
<span class="o">//</span> <span class="n">SPDX</span><span class="o">-</span><span class="n">License</span><span class="o">-</span><span class="n">Identifier</span><span class="p">:</span> <span class="n">Apache</span><span class="o">-</span><span class="mf">2.0</span> <span class="n">WITH</span> <span class="n">LLVM</span><span class="o">-</span><span class="n">exception</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0.h&quot;</span>
<span class="c1">#include &quot;ToolChains/CommonArgs.h&quot;</span>
<span class="c1">#include &quot;clang/Driver/Driver.h&quot;</span>
<span class="c1">#include &quot;clang/Driver/DriverDiagnostic.h&quot;</span>
<span class="c1">#include &quot;clang/Driver/Options.h&quot;</span>
<span class="c1">#include &quot;llvm/ADT/StringSwitch.h&quot;</span>
<span class="c1">#include &quot;llvm/Option/ArgList.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">clang</span><span class="p">::</span><span class="n">driver</span><span class="p">;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">clang</span><span class="p">::</span><span class="n">driver</span><span class="p">::</span><span class="n">tools</span><span class="p">;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">clang</span><span class="p">;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">::</span><span class="n">opt</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Get</span> <span class="n">CPU</span> <span class="ow">and</span> <span class="n">ABI</span> <span class="n">names</span><span class="o">.</span> <span class="n">They</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">independent</span>
<span class="o">//</span> <span class="n">so</span> <span class="n">we</span> <span class="n">have</span> <span class="n">to</span> <span class="n">calculate</span> <span class="n">them</span> <span class="n">together</span><span class="o">.</span>
<span class="n">void</span> <span class="n">cpu0</span><span class="p">::</span><span class="n">getCpu0CPUAndABI</span><span class="p">(</span><span class="n">const</span> <span class="n">ArgList</span> <span class="o">&amp;</span><span class="n">Args</span><span class="p">,</span> <span class="n">const</span> <span class="n">llvm</span><span class="p">::</span><span class="n">Triple</span> <span class="o">&amp;</span><span class="n">Triple</span><span class="p">,</span>
                            <span class="n">StringRef</span> <span class="o">&amp;</span><span class="n">CPUName</span><span class="p">,</span> <span class="n">StringRef</span> <span class="o">&amp;</span><span class="n">ABIName</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Arg</span> <span class="o">*</span><span class="n">A</span> <span class="o">=</span> <span class="n">Args</span><span class="o">.</span><span class="n">getLastArg</span><span class="p">(</span><span class="n">clang</span><span class="p">::</span><span class="n">driver</span><span class="p">::</span><span class="n">options</span><span class="p">::</span><span class="n">OPT_march_EQ</span><span class="p">,</span>
                               <span class="n">options</span><span class="p">::</span><span class="n">OPT_mcpu_EQ</span><span class="p">))</span>
    <span class="n">CPUName</span> <span class="o">=</span> <span class="n">A</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Arg</span> <span class="o">*</span><span class="n">A</span> <span class="o">=</span> <span class="n">Args</span><span class="o">.</span><span class="n">getLastArg</span><span class="p">(</span><span class="n">options</span><span class="p">::</span><span class="n">OPT_mabi_EQ</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">ABIName</span> <span class="o">=</span> <span class="n">A</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span>
    <span class="o">//</span> <span class="n">Convert</span> <span class="n">a</span> <span class="n">GNU</span> <span class="n">style</span> <span class="n">Cpu0</span> <span class="n">ABI</span> <span class="n">name</span> <span class="n">to</span> <span class="n">the</span> <span class="n">name</span>
    <span class="o">//</span> <span class="n">accepted</span> <span class="n">by</span> <span class="n">LLVM</span> <span class="n">Cpu0</span> <span class="n">backend</span><span class="o">.</span>
    <span class="n">ABIName</span> <span class="o">=</span> <span class="n">llvm</span><span class="p">::</span><span class="n">StringSwitch</span><span class="o">&lt;</span><span class="n">llvm</span><span class="p">::</span><span class="n">StringRef</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ABIName</span><span class="p">)</span>
                  <span class="o">.</span><span class="n">Case</span><span class="p">(</span><span class="s2">&quot;32&quot;</span><span class="p">,</span> <span class="s2">&quot;o32&quot;</span><span class="p">)</span>
                  <span class="o">.</span><span class="n">Default</span><span class="p">(</span><span class="n">ABIName</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="o">//</span> <span class="n">Setup</span> <span class="n">default</span> <span class="n">CPU</span> <span class="ow">and</span> <span class="n">ABI</span> <span class="n">names</span><span class="o">.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">CPUName</span><span class="o">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">switch</span> <span class="p">(</span><span class="n">Triple</span><span class="o">.</span><span class="n">getArch</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">default</span><span class="p">:</span>
      <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s2">&quot;Unexpected triple arch name&quot;</span><span class="p">);</span>
    <span class="n">case</span> <span class="n">llvm</span><span class="p">::</span><span class="n">Triple</span><span class="p">::</span><span class="n">cpu0</span><span class="p">:</span>
    <span class="n">case</span> <span class="n">llvm</span><span class="p">::</span><span class="n">Triple</span><span class="p">::</span><span class="n">cpu0el</span><span class="p">:</span>
      <span class="n">CPUName</span> <span class="o">=</span> <span class="s2">&quot;cpu032II&quot;</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ABIName</span><span class="o">.</span><span class="n">empty</span><span class="p">())</span>
    <span class="n">ABIName</span> <span class="o">=</span> <span class="s2">&quot;o32&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">exlbt/clang/include/clang/lib/Basic/CMakeLists.txt</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Targets/Cpu0.cpp</span>
</pre></div>
</div>
<p class="rubric">exlbt/clang/include/clang/lib/Basic/Targets.cpp</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span>include <span class="s2">&quot;Targets/Cpu0.h&quot;</span>
<span class="go">...</span>
<span class="go">  case llvm::Triple::cpu0:</span>
<span class="go">    switch (os) {</span>
<span class="go">    case llvm::Triple::Linux:</span>
<span class="go">      return new LinuxTargetInfo&lt;Cpu0TargetInfo&gt;(Triple, Opts);</span>
<span class="go">    case llvm::Triple::RTEMS:</span>
<span class="go">      return new RTEMSTargetInfo&lt;Cpu0TargetInfo&gt;(Triple, Opts);</span>
<span class="go">    case llvm::Triple::FreeBSD:</span>
<span class="go">     return new FreeBSDTargetInfo&lt;Cpu0TargetInfo&gt;(Triple, Opts);</span>
<span class="go">    case llvm::Triple::NetBSD:</span>
<span class="go">     return new NetBSDTargetInfo&lt;Cpu0TargetInfo&gt;(Triple, Opts);</span>
<span class="go">    default:</span>
<span class="go">      return new Cpu0TargetInfo(Triple, Opts);</span>
<span class="go">    }</span>

<span class="go">  case llvm::Triple::cpu0el:</span>
<span class="go">    switch (os) {</span>
<span class="go">    case llvm::Triple::Linux:</span>
<span class="go">      return new LinuxTargetInfo&lt;Cpu0TargetInfo&gt;(Triple, Opts);</span>
<span class="go">    case llvm::Triple::RTEMS:</span>
<span class="go">      return new RTEMSTargetInfo&lt;Cpu0TargetInfo&gt;(Triple, Opts);</span>
<span class="go">    case llvm::Triple::FreeBSD:</span>
<span class="go">      return new FreeBSDTargetInfo&lt;Cpu0TargetInfo&gt;(Triple, Opts);</span>
<span class="go">    case llvm::Triple::NetBSD:</span>
<span class="go">      return new NetBSDTargetInfo&lt;Cpu0TargetInfo&gt;(Triple, Opts);</span>
<span class="go">    default:</span>
<span class="go">      return new Cpu0TargetInfo(Triple, Opts);</span>
<span class="go">    }</span>
</pre></div>
</div>
<p class="rubric">exlbt/clang/lib/Basic/Targets/Cpu0.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//===--- Cpu0.h - Declare Cpu0 target feature support -----------*- C++ -*-===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//
//
// This file declares Cpu0 TargetInfo objects.
//
//===----------------------------------------------------------------------===//

#ifndef LLVM_CLANG_LIB_BASIC_TARGETS_CPU0_H
#define LLVM_CLANG_LIB_BASIC_TARGETS_CPU0_H

#include &quot;clang/Basic/TargetInfo.h&quot;
#include &quot;clang/Basic/TargetOptions.h&quot;
#include &quot;llvm/ADT/Triple.h&quot;
#include &quot;llvm/Support/Compiler.h&quot;

namespace clang {
namespace targets {

class LLVM_LIBRARY_VISIBILITY Cpu0TargetInfo : public TargetInfo {
  void setDataLayout() {
    StringRef Layout;

    if (ABI == &quot;o32&quot;)
      Layout = &quot;m:m-p:32:32-i8:8:32-i16:16:32-i64:64-n32-S64&quot;;
    else if (ABI == &quot;n32&quot;)
      Layout = &quot;m:e-p:32:32-i8:8:32-i16:16:32-i64:64-n32:64-S128&quot;;
    else if (ABI == &quot;n64&quot;)
      Layout = &quot;m:e-i8:8:32-i16:16:32-i64:64-n32:64-S128&quot;;
    else
      llvm_unreachable(&quot;Invalid ABI&quot;);

    if (BigEndian)
      resetDataLayout((&quot;E-&quot; + Layout).str());
    else
      resetDataLayout((&quot;e-&quot; + Layout).str());
  }

  static const Builtin::Info BuiltinInfo[];
  std::string CPU;
  
protected:
  std::string ABI;
  enum Cpu0FloatABI { HardFloat, SoftFloat } FloatABI;

public:
  Cpu0TargetInfo(const llvm::Triple &amp;Triple, const TargetOptions &amp;Opt)
      : TargetInfo(Triple) {
    TheCXXABI.set(TargetCXXABI::GenericMIPS); // Cpu0 uses Mips ABI

    setABI(&quot;o32&quot;);

    CPU = &quot;cpu032II&quot;;
  }

  StringRef getABI() const override { return ABI; }

  bool setABI(const std::string &amp;Name) override {
    if (Name == &quot;o32&quot;) {
      ABI = Name;
      return true;
    }
    return false;
  }

  bool isValidCPUName(StringRef Name) const override;

  bool setCPU(const std::string &amp;Name) override {
    CPU = Name;
    return isValidCPUName(Name);
  }

  const std::string &amp;getCPU() const { return CPU; }
  bool
  initFeatureMap(llvm::StringMap&lt;bool&gt; &amp;Features, DiagnosticsEngine &amp;Diags,
                 StringRef CPU,
                 const std::vector&lt;std::string&gt; &amp;FeaturesVec) const override {
    if (CPU.empty())
      CPU = getCPU();
    if (CPU == &quot;cpu032II&quot;)
      Features[&quot;HasCmp&quot;] = Features[&quot;HasSlt&quot;] = true;
    else if (CPU == &quot;cpu032I&quot;)
      Features[&quot;HasCmp&quot;] = true;
    else
      assert(0 &amp;&amp; &quot;incorrect CPU&quot;);
    return TargetInfo::initFeatureMap(Features, Diags, CPU, FeaturesVec);
  }

  unsigned getISARev() const;

  void getTargetDefines(const LangOptions &amp;Opts,
                        MacroBuilder &amp;Builder) const override;

  ArrayRef&lt;Builtin::Info&gt; getTargetBuiltins() const override;

  bool hasFeature(StringRef Feature) const override;

  BuiltinVaListKind getBuiltinVaListKind() const override {
    return TargetInfo::VoidPtrBuiltinVaList;
  }

  ArrayRef&lt;const char *&gt; getGCCRegNames() const override {
    static const char *const GCCRegNames[] = {
        // CPU register names
        // Must match second column of GCCRegAliases
        &quot;$0&quot;, &quot;$1&quot;, &quot;$2&quot;, &quot;$3&quot;, &quot;$4&quot;, &quot;$5&quot;, &quot;$6&quot;, &quot;$7&quot;, &quot;$8&quot;, &quot;$9&quot;, &quot;$10&quot;,
        &quot;$11&quot;, &quot;$12&quot;, &quot;$13&quot;, &quot;$14&quot;, &quot;$15&quot;,
        // Hi/lo and condition register names
        &quot;hi&quot;, &quot;lo&quot;, 
    };
    return llvm::makeArrayRef(GCCRegNames);
  }

  bool validateAsmConstraint(const char *&amp;Name,
                             TargetInfo::ConstraintInfo &amp;Info) const override {
    switch (*Name) {
    default:
      return false;
    case &#39;r&#39;: // CPU registers.
    case &#39;d&#39;: // Equivalent to &quot;r&quot; unless generating MIPS16 code.
    case &#39;y&#39;: // Equivalent to &quot;r&quot;, backward compatibility only.
    //case &#39;f&#39;: // floating-point registers.
    case &#39;c&#39;: // $6 for indirect jumps
    case &#39;l&#39;: // lo register
    case &#39;x&#39;: // hilo register pair
      Info.setAllowsRegister();
      return true;
    case &#39;I&#39;: // Signed 16-bit constant
    case &#39;J&#39;: // Integer 0
    case &#39;K&#39;: // Unsigned 16-bit constant
    case &#39;L&#39;: // Signed 32-bit constant, lower 16-bit zeros (for lui)
    case &#39;M&#39;: // Constants not loadable via lui, addiu, or ori
    case &#39;N&#39;: // Constant -1 to -65535
    case &#39;O&#39;: // A signed 15-bit constant
    case &#39;P&#39;: // A constant between 1 go 65535
      return true;
    case &#39;R&#39;: // An address that can be used in a non-macro load or store
      Info.setAllowsMemory();
      return true;
    case &#39;Z&#39;:
      if (Name[1] == &#39;C&#39;) { // An address usable by ll, and sc.
        Info.setAllowsMemory();
        Name++; // Skip over &#39;Z&#39;.
        return true;
      }
      return false;
    }
  }

  const char *getClobbers() const override {
    // In GCC, $1 is not widely used in generated code (it&#39;s used only in a few
    // specific situations), so there is no real need for users to add it to
    // the clobbers list if they want to use it in their inline assembly code.
    //
    // In LLVM, $1 is treated as a normal GPR and is always allocatable during
    // code generation, so using it in inline assembly without adding it to the
    // clobbers list can cause conflicts between the inline assembly code and
    // the surrounding generated code.
    //
    // Another problem is that LLVM is allowed to choose $1 for inline assembly
    // operands, which will conflict with the &quot;.set at&quot; assembler option (which
    // we use only for inline assembly, in order to maintain compatibility with
    // GCC) and will also conflict with the user&#39;s usage of $1.
    //
    // The easiest way to avoid these conflicts and keep $1 as an allocatable
    // register for generated code is to automatically clobber $1 for all inline
    // assembly code.
    //
    // FIXME: We should automatically clobber $1 only for inline assembly code
    // which actually uses it. This would allow LLVM to use $1 for inline
    // assembly operands if the user&#39;s assembly code doesn&#39;t use it.
    return &quot;~{$1}&quot;;
  }


  bool handleTargetFeatures(std::vector&lt;std::string&gt; &amp;Features,
                            DiagnosticsEngine &amp;Diags) override {
    FloatABI = SoftFloat;

    for (const auto &amp;Feature : Features) {
      if (Feature == &quot;+cpu032I&quot;)
        setCPU(&quot;cpu032I&quot;);
      else if (Feature == &quot;+cpu032II&quot;)
        setCPU(&quot;cpu032II&quot;);
      else if (Feature == &quot;+soft-float&quot;)
        FloatABI = SoftFloat;
    }

    setDataLayout();

    return true;
  }

  ArrayRef&lt;TargetInfo::GCCRegAlias&gt; getGCCRegAliases() const override {
    static const TargetInfo::GCCRegAlias RegAliases[] = {
        {{&quot;at&quot;}, &quot;$1&quot;},  {{&quot;v0&quot;}, &quot;$2&quot;},         {{&quot;v1&quot;}, &quot;$3&quot;},
        {{&quot;a0&quot;}, &quot;$4&quot;},  {{&quot;a1&quot;}, &quot;$5&quot;},         {{&quot;t9&quot;}, &quot;$6&quot;},
        {{&quot;gp&quot;}, &quot;$11&quot;}, {{&quot;fp&quot;}, &quot;$12&quot;},        {{&quot;sp&quot;}, &quot;$13&quot;},
        {{&quot;lr&quot;}, &quot;$14&quot;}, {{&quot;sw&quot;}, &quot;$15&quot;}
    };
    return llvm::makeArrayRef(RegAliases);
  }

  bool hasInt128Type() const override {
    return false;
  }

  unsigned getUnwindWordWidth() const override;

  bool validateTarget(DiagnosticsEngine &amp;Diags) const override;
  bool hasExtIntType() const override { return true; }
};
} // namespace targets
} // namespace clang

#endif // LLVM_CLANG_LIB_BASIC_TARGETS_Cpu0_H
</pre></div>
</div>
<p class="rubric">exlbt/clang/lib/Basic/Targets/Cpu0.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//===--- Cpu0.cpp - Implement Cpu0 target feature support -----------------===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//
//
// This file implements Cpu0 TargetInfo objects.
//
//===----------------------------------------------------------------------===//

#include &quot;Cpu0.h&quot;
#include &quot;Targets.h&quot;
#include &quot;clang/Basic/Diagnostic.h&quot;
#include &quot;clang/Basic/MacroBuilder.h&quot;
#include &quot;clang/Basic/TargetBuiltins.h&quot;
#include &quot;llvm/ADT/StringSwitch.h&quot;

using namespace clang;
using namespace clang::targets;

const Builtin::Info Cpu0TargetInfo::BuiltinInfo[] = {
#define BUILTIN(ID, TYPE, ATTRS)                                               \
  {#ID, TYPE, ATTRS, nullptr, ALL_LANGUAGES, nullptr},
#define LIBBUILTIN(ID, TYPE, ATTRS, HEADER)                                    \
  {#ID, TYPE, ATTRS, HEADER, ALL_LANGUAGES, nullptr},
#include &quot;clang/Basic/BuiltinsCpu0.def&quot;
};

static constexpr llvm::StringLiteral ValidCPUNames[] = {
    {&quot;cpu032I&quot;},  {&quot;cpu032II&quot;}};

bool Cpu0TargetInfo::isValidCPUName(StringRef Name) const {
  return llvm::find(ValidCPUNames, Name) != std::end(ValidCPUNames);
}

unsigned Cpu0TargetInfo::getISARev() const {
  return llvm::StringSwitch&lt;unsigned&gt;(getCPU())
             .Case(&quot;cpu032I&quot;, 1)
             .Case(&quot;cpu032II&quot;, 2)
             .Default(0);
}

void Cpu0TargetInfo::getTargetDefines(const LangOptions &amp;Opts,
                                      MacroBuilder &amp;Builder) const {
  if (BigEndian) {
    DefineStd(Builder, &quot;CPU0EB&quot;, Opts);
    Builder.defineMacro(&quot;_CPU0EB&quot;);
  } else {
    DefineStd(Builder, &quot;CPU0EL&quot;, Opts);
    Builder.defineMacro(&quot;_CPU0EL&quot;);
  }

  Builder.defineMacro(&quot;__cpu0__&quot;);
  Builder.defineMacro(&quot;_cpu0&quot;);
  if (Opts.GNUMode)
    Builder.defineMacro(&quot;cpu0&quot;);

  if (ABI == &quot;o32&quot; || ABI == &quot;s32&quot;) {
    Builder.defineMacro(&quot;__cpu0&quot;, &quot;32&quot;);
    Builder.defineMacro(&quot;_CPU0_ISA&quot;, &quot;_CPU0_ISA_CPU032&quot;);
  } else {
    llvm_unreachable(&quot;Invalid ABI.&quot;);
  }

  const std::string ISARev = std::to_string(getISARev());

  if (!ISARev.empty())
    Builder.defineMacro(&quot;__cpu0_isa_rev&quot;, ISARev);

  if (ABI == &quot;o32&quot;) {
    Builder.defineMacro(&quot;__cpu0_o32&quot;);
    Builder.defineMacro(&quot;_ABIO32&quot;, &quot;1&quot;);
    Builder.defineMacro(&quot;_CPU0_SIM&quot;, &quot;_ABIO32&quot;);
  } else if (ABI == &quot;s32&quot;) {
    Builder.defineMacro(&quot;__cpu0_n32&quot;);
    Builder.defineMacro(&quot;_ABIS32&quot;, &quot;2&quot;);
    Builder.defineMacro(&quot;_CPU0_SIM&quot;, &quot;_ABIN32&quot;);
  } else
    llvm_unreachable(&quot;Invalid ABI.&quot;);

  Builder.defineMacro(&quot;__REGISTER_PREFIX__&quot;, &quot;&quot;);

  switch (FloatABI) {
  case HardFloat:
    llvm_unreachable(&quot;HardFloat is not support in Cpu0&quot;);
    break;
  case SoftFloat:
    Builder.defineMacro(&quot;__cpu0_soft_float&quot;, Twine(1));
    break;
  }
}

bool Cpu0TargetInfo::hasFeature(StringRef Feature) const {
  return llvm::StringSwitch&lt;bool&gt;(Feature)
      .Case(&quot;cpu0&quot;, true)
      .Default(false);
}

ArrayRef&lt;Builtin::Info&gt; Cpu0TargetInfo::getTargetBuiltins() const {
  return llvm::makeArrayRef(BuiltinInfo, clang::Cpu0::LastTSBuiltin -
                                             Builtin::FirstTSBuiltin);
}

unsigned Cpu0TargetInfo::getUnwindWordWidth() const {
  return llvm::StringSwitch&lt;unsigned&gt;(ABI)
      .Cases(&quot;o32&quot;, &quot;s32&quot;, 32)
      .Default(getPointerWidth(0));
}

bool Cpu0TargetInfo::validateTarget(DiagnosticsEngine &amp;Diags) const {
  if (CPU != &quot;cpu032I&quot; &amp;&amp; CPU != &quot;cpu032II&quot;) {
    Diags.Report(diag::err_target_unknown_cpu) &lt;&lt; ABI &lt;&lt; CPU;
    return false;
  }

  return true;
}
</pre></div>
</div>
</section>
<section id="verify">
<h2><a class="toc-backref" href="#id2">Verify</a><a class="headerlink" href="#verify" title="Permalink to this headline">¶</a></h2>
<p class="rubric">exlbt/input/build-slinker-2.sh</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/usr/bin/env bash

source functions.sh

sh_name=build-slinker.sh
argNum=$#
arg1=$1
arg2=$2

prologue;

# -mcpu cannot pass to llvm via -mllvm while -has-lld can. So add cpu032I and cpu032II in 
# clang/include/clang/Driver/Options.td

${CLANG} -target cpu0${endian}-unknown-linux-gnu -c start.cpp -static \
  -fintegrated-as -o start.o  -mcpu=${CPU} -mllvm -has-lld=true
${CLANG} -target cpu0${endian}-unknown-linux-gnu -c debug.cpp -static \
  -fintegrated-as -o debug.o -mcpu=${CPU} -mllvm -has-lld=true
${CLANG} -target cpu0${endian}-unknown-linux-gnu -c printf-stdarg-def.c -static \
  -fintegrated-as -o printf-stdarg-def.o -mcpu=${CPU} -mllvm -has-lld=true
${CLANG} -target cpu0${endian}-unknown-linux-gnu -c printf-stdarg.c -static \
  -fintegrated-as -o printf-stdarg.o -mcpu=${CPU} -mllvm -has-lld=true
${CLANG} -target cpu0${endian}-unknown-linux-gnu -c \
  ${LBDEXDIR}/input/ch4_1_addsuboverflow.cpp -static -fintegrated-as \
  -o ch4_1_addsuboverflow.o -mcpu=${CPU} -mllvm -has-lld=true
${CLANG} -target cpu0${endian}-unknown-linux-gnu -c \
  ${LBDEXDIR}/input/ch8_1_br_jt.cpp -static -fintegrated-as -o ch8_1_br_jt.o \
  -mcpu=${CPU} -mllvm -has-lld=true
${CLANG} -O3 -target cpu0${endian}-unknown-linux-gnu -c \
  ${LBDEXDIR}/input/ch8_2_phinode.cpp -static -fintegrated-as -o ch8_2_phinode.o \
  -mcpu=${CPU} -mllvm -has-lld=true
${CLANG} -target cpu0${endian}-unknown-linux-gnu -c \
  ${LBDEXDIR}/input/ch8_1_blockaddr.cpp -static -fintegrated-as \
  -o ch8_1_blockaddr.o -mcpu=${CPU} -mllvm -has-lld=true
${CLANG} -target cpu0${endian}-unknown-linux-gnu -c \
  ${LBDEXDIR}/input/ch8_2_longbranch.cpp -static -fintegrated-as \
  -o ch8_2_longbranch.o -mcpu=${CPU} -mllvm -has-lld=true
${CLANG} -O1 -target cpu0${endian}-unknown-linux-gnu -c \
  ${LBDEXDIR}/input/ch9_2_tailcall.cpp -static -fintegrated-as \
  -o ch9_2_tailcall.o -mcpu=${CPU} -mllvm -has-lld=true
${CLANG} -target cpu0${endian}-unknown-linux-gnu -c \
${LBDEXDIR}/input/ch9_3_detect_exception.cpp -static -fintegrated-as \
  -o ch9_3_detect_exception.o -mcpu=${CPU} -mllvm -has-lld=true
${CLANG} -I${LBDEXDIR}/input/ -target cpu0${endian}-unknown-linux-gnu \
  -c ch_slinker.cpp -static -fintegrated-as -o ch_slinker.o -mcpu=${CPU} \
  -mllvm -has-lld=true

${TOOLDIR}/llc -march=cpu0${endian} -mcpu=${CPU} -relocation-model=static \
  -filetype=obj -has-lld=true lib_cpu0.ll -o lib_cpu0.o

${TOOLDIR}/lld -flavor gnu start.o \
  debug.o printf-stdarg-def.o printf-stdarg.o ch4_1_addsuboverflow.o \
  ch8_1_br_jt.o ch8_2_phinode.o ch8_1_blockaddr.o ch8_2_longbranch.o \
  ch9_2_tailcall.o ch9_3_detect_exception.o ch_slinker.o lib_cpu0.o -o a.out

epilogue;

</pre></div>
</div>
<p>Build and run as follows,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">JonathantekiiMac:input Jonathan$ </span>bash build-slinker-2.sh cpu032I le
<span class="go">...</span>
<span class="go">endian =  LittleEndian</span>
<span class="gp">JonathantekiiMac:input Jonathan$ </span>iverilog -o cpu0Is cpu0Is.v
<span class="gp">114-43-184-210:verilog Jonathan$ </span>./cpu0Is
<span class="go">...</span>

<span class="gp">JonathantekiiMac:input Jonathan$ </span>bash build-slinker-2.sh cpu032II be
<span class="go">...</span>
<span class="go">endian =  BigEndian</span>
<span class="gp">JonathantekiiMac:input Jonathan$ </span>iverilog -o cpu0IIs cpu0IIs.v
<span class="gp">114-43-184-210:verilog Jonathan$ </span>./cpu0IIs
<span class="go">...</span>
</pre></div>
</div>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="lib.html">Library</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Chen Chung-Shu.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.1.
    </div>
  </body>
</html>